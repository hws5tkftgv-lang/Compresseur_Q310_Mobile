<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Q310 ‚Äì iPhone √âditeur</title>

<script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>

<style>
html,body{
  margin:0;
  background:#0b1436;
  color:#eaf1ff;
  font-family:Arial,Segoe UI,sans-serif;
}

#infoPanel{
  padding:10px;
  background:#0f1a44;
  border-bottom:1px solid rgba(255,255,255,.15);
}
#infoTitle{font-size:18px;font-weight:800;}

.stage{
  position:relative;
  height:calc(100dvh - 120px);
  overflow:hidden;
}
.media-layer,canvas{position:absolute;inset:0;}
#imgLayer{
  width:100%;
  height:100%;
  object-fit:contain;
  pointer-events:none;
}

/* iOS SAFARI CRITICAL */
.stage, .canvas-container, canvas{
  touch-action:none !important;
}

/* FAB */
#fab{
  position:fixed;
  bottom:10px;
  left:10px;
  width:46px;
  height:46px;
  border-radius:10px;
  background:#ffffff22;
  border:1px solid #ffffff55;
  color:#fff;
  font-size:22px;
  z-index:9999;
}

/* PANEL */
#panel{
  position:fixed;
  left:10px;
  bottom:70px;
  width:calc(100vw - 20px);
  max-height:70dvh;
  overflow:auto;
  background:#0f1a44;
  border:1px solid rgba(255,255,255,.2);
  display:none;
  z-index:9999;
}

.btn{
  width:100%;
  min-height:44px;
  margin-top:8px;
  background:#1b2553;
  color:#fff;
  border:1px solid rgba(255,255,255,.2);
  border-radius:10px;
  font-size:15px;
  font-weight:700;
}

.btn.active{
  background:#ff9800;
  color:#000;
}

#editorState{
  position:fixed;
  top:10px;
  right:10px;
  background:#ff9800;
  color:#000;
  padding:6px 10px;
  font-weight:900;
  border-radius:8px;
  display:none;
  z-index:9999;
}
</style>
</head>

<body>

<div id="infoPanel">
  <div id="infoTitle">S√©lectionne une zone</div>
</div>

<div class="stage" id="stage">
  <div class="media-layer">
    <img id="imgLayer" src="actif/compresseur_bg.png">
  </div>
  <canvas id="c"></canvas>
</div>

<button id="fab">‚ò∞</button>

<div id="panel">
  <button id="btnEditor" class="btn">üîí Activer √©diteur</button>
  <button id="btnMove" class="btn">‚úã D√©placer</button>
  <button id="btnResize" class="btn">‚¨ç Redimensionner</button>
  <button id="btnDraw" class="btn">‚ûï Nouvelle zone</button>
</div>

<div id="editorState">MODE √âDITEUR</div>

<script>
const EDITOR_PASSWORD="comp";
const IMAGE_URL="actif/compresseur_bg.png";

const $=id=>document.getElementById(id);

let isEditor=false;
let tool="view";
let drawing=false;
let start=null;
let tempRect=null;

/* ===== FABRIC ===== */
const canvas=new fabric.Canvas("c",{selection:false});
fabric.Object.prototype.perPixelTargetFind=true;
fabric.Object.prototype.targetFindTolerance=20;
fabric.Object.prototype.cornerSize=30;
fabric.Object.prototype.cornerStyle="circle";
fabric.Object.prototype.transparentCorners=false;

function resize(){
  canvas.setWidth($("stage").clientWidth);
  canvas.setHeight($("stage").clientHeight);
}
window.addEventListener("resize",resize);
resize();

/* ===== MENU ===== */
$("fab").onclick=()=>{
  $("panel").style.display = $("panel").style.display==="block"?"none":"block";
};

/* ===== MODE √âDITEUR ===== */
$("btnEditor").onclick=()=>{
  if(!isEditor){
    if(prompt("Mot de passe")!==EDITOR_PASSWORD) return;
    isEditor=true;
    $("editorState").style.display="block";
    $("btnEditor").textContent="üîì √âditeur actif";
  }else{
    isEditor=false;
    $("editorState").style.display="none";
    $("btnEditor").textContent="üîí Activer √©diteur";
  }
  applyMode();
};

$("btnMove").onclick=()=>{tool="move";applyMode();};
$("btnResize").onclick=()=>{tool="resize";applyMode();};
$("btnDraw").onclick=()=>{tool="draw";applyMode();};

function applyMode(){
  canvas.forEachObject(o=>{
    o.selectable = isEditor && tool!=="draw";
    o.hasControls = isEditor && tool==="resize";
    o.hasBorders = isEditor;
    o.stroke = isEditor ? "orange" : "white";
  });
  canvas.requestRenderAll();
}

/* ===== DRAW ===== */
canvas.on("mouse:down",opt=>{
  if(!(isEditor && tool==="draw")) return;
  drawing=true;
  const p=canvas.getPointer(opt.e);
  start=p;
  tempRect=new fabric.Rect({
    left:p.x, top:p.y,
    width:2, height:2,
    fill:"transparent",
    stroke:"#00a2ff",
    strokeWidth:3
  });
  canvas.add(tempRect);
});

canvas.on("mouse:move",opt=>{
  if(!drawing || !tempRect) return;
  const p=canvas.getPointer(opt.e);
  tempRect.set({
    width:Math.abs(p.x-start.x),
    height:Math.abs(p.y-start.y)
  });
  canvas.requestRenderAll();
});

canvas.on("mouse:up",()=>{
  drawing=false;
  tempRect=null;
});

/* ===== DEMO ZONE ===== */
const z=new fabric.Rect({
  left:100, top:100, width:160, height:200,
  fill:"transparent", stroke:"white", strokeWidth:3
});
canvas.add(z);
</script>

</body>
</html>