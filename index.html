<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Q310 ‚Äì iPhone √âditeur (Clean)</title>

<script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>

<style>

.mediaBlock{
  margin-bottom:20px;
}

.mediaBlock img,
.mediaBlock iframe,
.mediaBlock video{
  width:100%;
  border-radius:12px;
  background:#000;
}

html, body{
  margin:0;
  height:100%;
  overflow:hidden;
  background:#0b1436;
  color:#eaf1ff;
  font-family:Arial,Segoe UI,sans-serif;
}

#infoPanel{
  padding:10px;
  background:#0f1a44;
  border-bottom:1px solid rgba(255,255,255,.15);
}
#infoTitle{ font-size:18px; font-weight:800; }
#infoText{ font-size:14px; opacity:.9; margin-top:4px; }

.stage{
  position:relative;
  height:calc(100dvh - 120px);
  overflow:hidden;
  background:#0b1536;
}
.media-layer, .canvas-wrap{
  position:absolute;
  inset:0;
}
#imgLayer{
  width:100%;
  height:100%;
  object-fit:contain;
  pointer-events:none;
}

/* IMPORTANT iOS : emp√™cher Safari de prendre le scroll/pinch */
.stage, .canvas-container, canvas{
  touch-action:none !important;
}

#fab{
  position:fixed;
  bottom:10px;
  left:10px;
  width:46px;
  height:46px;
  border-radius:10px;
  background:#ffffff22;
  border:1px solid #ffffff55;
  color:#fff;
  font-size:22px;
  z-index:9999;
}

#panel{
  position:fixed;
  left:10px;
  bottom:70px;
  width:calc(100vw - 20px);
  max-height:65vh;
  overflow-y:auto;
  overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
  background:#0f1a44;
  border:1px solid rgba(255,255,255,.2);
  padding:10px;
  border-radius:12px;
  display:none;
  z-index:10000;
}

.sectionTitle{
  margin-top:12px;
  font-size:12px;
  opacity:.7;
  font-weight:700;
  text-transform:uppercase;
}

.btn{
  width:100%;
  min-height:44px;
  margin-top:8px;
  background:#1b2553;
  color:#fff;
  border:1px solid rgba(255,255,255,.2);
  border-radius:10px;
  font-size:15px;
  font-weight:800;
}
.btn.active{ background:#ff9800; color:#000; }

.input{
  width:100%;
  min-height:44px;
  margin-top:8px;
  background:#101a40;
  color:#fff;
  border:1px solid rgba(255,255,255,.2);
  border-radius:10px;
  font-size:15px;
  padding:10px;
  box-sizing:border-box;
}

#editorState{
  position:fixed;
  top:10px;
  right:10px;          /* ‚úÖ √† droite */
  background:#ff9800;
  color:#000;
  padding:6px 12px;
  border-radius:999px; /* ‚úÖ pastille discr√®te */
  font-weight:900;
  font-size:12px;
  z-index:9999;
  display:none;
  box-shadow:0 2px 6px rgba(0,0,0,.35);
}
</style>
</head>

<body>

<!-- Bande info √©l√®ve -->
<div id="infoPanel">
  <div id="infoTitle">S√©lectionne une zone</div>
  <div id="infoText"></div>
</div>

<!-- Image + Canvas -->
<div class="stage" id="stage">
  <div class="media-layer">
    <img id="imgLayer" src="actif/compresseur_bg.png" alt="">
  </div>
  <div class="canvas-wrap">
    <canvas id="c"></canvas>
  </div>
</div>

<!-- Menu -->
<button id="fab">‚ò∞</button>

<div id="panel">
  <div style="font-weight:900;margin-bottom:6px;">üß∞ Menu</div>

  <div id="stateLine" style="font-weight:900;opacity:.9;">MODE √âL√àVE</div>

  <input id="pw" class="input" type="password" placeholder="Mot de passe √©diteur (comp)">
  <button id="btnEditor" class="btn">üîí Activer √©diteur</button>
  <button id="btnExit" class="btn" style="display:none;">üö™ Quitter √©diteur</button>

  <div class="sectionTitle">Outils</div>
  <button id="btnMove" class="btn" disabled>‚úã D√©placer</button>
  <button id="btnResize" class="btn" disabled>‚¨ç Redimensionner</button>
  <button id="btnDraw" class="btn" disabled>‚ûï Nouvelle zone</button>

  <div class="sectionTitle">Zone s√©lectionn√©e</div>
  <input id="editNom" class="input" placeholder="Nom">
  <textarea id="editRole" class="input" placeholder="R√¥le"></textarea>
  <textarea id="editDesc" class="input" placeholder="Description"></textarea>
  <button id="btnApply" class="btn">üíæ Appliquer</button>
  <button id="btnDelete" class="btn">üóëÔ∏è Supprimer la zone</button>

<!-- ===== ASSOCIATION PI√àCE ===== -->
<div class="sectionTitle">Associer une pi√®ce</div>
<div class="sectionTitle">M√©dias (pi√®ce)</div>

<button id="btnShowMedia" class="btn">üñºÔ∏èüé• Voir les m√©dias</button>
<select id="partSelect" class="input">
  <option value="">‚Äî Choisir une pi√®ce ‚Äî</option>
  <option value="__new__">‚ûï Nouvelle pi√®ce‚Ä¶</option>
</select>

<button id="btnLinkPart" class="btn">‚úî Associer la pi√®ce</button>

  <div class="sectionTitle">Sauvegarde</div>
  <button id="btnExport" class="btn">üì§ Export JSON</button>
</div>

<div id="editorState">‚úèÔ∏è MODE √âDITEUR</div>

<script>

let PARTS = {};        // index par id
let PARTS_LIST = [];  // liste brute depuis le JSON

fetch("quincy_310L_parts.json")
  .then(res => res.json())
  .then(data => {
    PARTS_LIST = data;

    // indexation par id
    data.forEach(p => {
      PARTS[p.id] = p;
    });

    remplirMenuPieces();
  })
  .catch(err => {
    console.error("Erreur chargement quincy_310L_parts.json", err);
  });
/* =========================
   CONFIG / DATA
========================= */
const $ = id => document.getElementById(id);
/* ===== √âTAPE 2 ‚Äî REMPLIR LE MENU DES PI√àCES ===== */
/* =========================
   PARTS ‚Äî Pi√®ces Quincy 310L
========================= */

const partSelect = $("partSelect");


const EDITOR_PASSWORD = "comp";
const STORAGE_KEY = "q310_zones_v1";

let isEditor = false;
let tool = "view"; // view | move | resize | draw
let selected = null;

let drawing = false;
let startPt = null;
let tempRect = null;

let zonesData = []; // [{id,x,y,w,h,nom,role,desc}]

/* =========================
   CANVAS
========================= */
const canvas = new fabric.Canvas("c", { selection:false });
canvas.selection = false;
canvas.preserveObjectStacking = true;

// iOS: emp√™cher gestes Safari
canvas.upperCanvasEl.style.touchAction = "none";
canvas.upperCanvasEl.style.webkitUserSelect = "none";
canvas.upperCanvasEl.style.webkitTouchCallout = "none";

// ergonomie tactile
fabric.Object.prototype.cornerSize = 36;
fabric.Object.prototype.cornerStyle = "circle";
fabric.Object.prototype.transparentCorners = false;
fabric.Object.prototype.padding = 10;

// s√©lection plus facile iPhone
fabric.Object.prototype.perPixelTargetFind = false;
fabric.Object.prototype.targetFindTolerance = 45;

/* =========================
   FIT CANVAS TO IMAGE (contain)
========================= */
function fitCanvasToImage(){
  const img = $("imgLayer");
  const stage = $("stage");
  if(!img.naturalWidth) return;

  const stageW = stage.clientWidth;
  const stageH = stage.clientHeight;

  const imgRatio = img.naturalWidth / img.naturalHeight;
  const stageRatio = stageW / stageH;

  let canvasW, canvasH;

  if(stageRatio > imgRatio){
    canvasH = stageH;
    canvasW = canvasH * imgRatio;
  }else{
    canvasW = stageW;
    canvasH = canvasW / imgRatio;
  }

  // centre canvas dans stage
  const offsetX = (stageW - canvasW) / 2;
  const offsetY = (stageH - canvasH) / 2;

  canvas.setWidth(canvasW);
  canvas.setHeight(canvasH);
  canvas.calcOffset();

  canvas.getElement().style.position = "absolute";
  canvas.getElement().style.left = offsetX + "px";
  canvas.getElement().style.top  = offsetY + "px";

  canvas.requestRenderAll();
}

$("imgLayer").addEventListener("load", fitCanvasToImage);
window.addEventListener("resize", fitCanvasToImage);

/* =========================
   SAVE / LOAD (localStorage)
========================= */
function saveToLocal(){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(zonesData));
  }catch(e){}
}

function loadFromLocal(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return false;
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return false;
    zonesData = arr;
    return true;
  }catch(e){
    return false;
  }
}

/* =========================
   CREATE RECT FROM DATA
========================= */
function makeRectFromZone(z){
  const r = new fabric.Rect({
    left: z.x,
    top: z.y,
    width: z.w,
    height: z.h,
    fill: "rgba(255,255,255,0.08)",
    stroke: "white",
    strokeWidth: 3,
    lockRotation: true
  });
  r.zoneId = z.id;
  r.zoneData = z;
  return r;
}

/* =========================
   BOOT: load zones
========================= */
function bootZones(){
  canvas.clear();

  // 1) load local zones if exist
  const hasLocal = loadFromLocal();

  // 2) fallback demo zones if none
  if(!hasLocal){
    zonesData = [
      { id:"cylindre_lp", x:420, y:180, w:120, h:260, nom:"Cylindre LP", role:"Compression initiale", desc:"Premi√®re √©tape de compression." },
      { id:"filtre_air",  x:120, y:220, w: 80, h:200, nom:"Filtre √† air", role:"Filtrer l‚Äôair entrant", desc:"Retient poussi√®res/impuret√©s." },
      { id:"manometre_hp",x:520, y:360, w:110, h:110, nom:"Manom√®tre HP", role:"Indiquer la pression", desc:"Lecture pression de service." }
    ];
    saveToLocal();
  }

  zonesData.forEach(z => canvas.add(makeRectFromZone(z)));

  applyMode();
  clearSelection();
  fitCanvasToImage();
}
bootZones();

function remplirMenuPieces(){
  const select = $("partSelect");

  select.innerHTML = `
    <option value="">‚Äî Choisir une pi√®ce ‚Äî</option>
    <option value="__new__">‚ûï Nouvelle pi√®ce‚Ä¶</option>
  `;

  PARTS_LIST.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = `${p.nom} (${p.circuit || "?"})`;
    select.appendChild(opt);
  });
}

/* =========================
   UI / MODES
========================= */
function setActiveBtn(btnId){
  ["btnMove","btnResize","btnDraw"].forEach(id => $(id).classList.remove("active"));
  if(btnId) $(btnId).classList.add("active");
}

function showAllResizeHandles(obj, on){
  obj.setControlsVisibility({
    tl:on, tr:on, bl:on, br:on,
    ml:on, mt:on, mr:on, mb:on,
    mtr:false
  });
}

function applyMode(){
  canvas.forEachObject(o => {

    // reset base
    o.stroke = (o === selected) ? "orange" : "white";
    o.strokeWidth = (o === selected) ? 5 : 3;

    // mode √©l√®ve
    if(!isEditor){
      o.evented = true;         // pour cliquer et lire
      o.selectable = false;
      o.hasControls = false;
      o.hasBorders = false;

      o.lockMovementX = true;
      o.lockMovementY = true;
      o.lockScalingX  = true;
      o.lockScalingY  = true;
      o.lockRotation  = true;

      showAllResizeHandles(o,false);
      return;
    }

    // mode √©diteur
    o.evented = true;
    o.lockRotation = true;

    if(tool === "draw"){
      o.selectable = false;
      o.hasControls = false;
      o.hasBorders = false;
      showAllResizeHandles(o,false);
      // IMPORTANT: on laisse evented=true (sinon s√©lection casse) mais on g√®re draw via handler
      return;
    }

    if(tool === "move"){
      o.selectable = true;
      o.hasControls = false;
      o.hasBorders = true;
      o.lockMovementX = false;
      o.lockMovementY = false;
      o.lockScalingX  = true;
      o.lockScalingY  = true;
      showAllResizeHandles(o,false);
      return;
    }

    if(tool === "resize"){
      o.selectable = true;
      o.hasControls = true;
      o.hasBorders = true;
      o.lockMovementX = false;
      o.lockMovementY = false;
      o.lockScalingX  = false;
      o.lockScalingY  = false;
      showAllResizeHandles(o,true);
      return;
    }

  });

  canvas.requestRenderAll();
}

function setUI(){
  $("editorState").style.display = isEditor ? "block" : "none";
  $("stateLine").textContent = isEditor ? "MODE √âDITEUR" : "MODE √âL√àVE";

  $("btnEditor").style.display = isEditor ? "none" : "block";
  $("btnExit").style.display   = isEditor ? "block" : "none";

  $("btnMove").disabled   = !isEditor;
  $("btnResize").disabled = !isEditor;
  $("btnDraw").disabled   = !isEditor;
$("btnShowMedia").disabled = !selected || !selected.zoneData || !selected.zoneData.partId;
$("btnLinkPart").disabled = !selected;
  setActiveBtn(isEditor ? (tool==="move"?"btnMove":tool==="resize"?"btnResize":tool==="draw"?"btnDraw":null) : null);

  applyMode();
}

/* =========================
   SELECTION + PANEL FIELDS
========================= */
function fillEditorFields(z){
  $("editNom").value  = z?.nom  || "";
  $("editRole").value = z?.role || "";
  $("editDesc").value = z?.desc || "";
}

function showInfo(z){
  if(!z){
    $("infoTitle").textContent = "S√©lectionne une zone";
    $("infoText").textContent = "";
    return;
  }

  // üß† Si la zone est li√©e √† une pi√®ce Quincy
  if(z.partId && PARTS[z.partId]){
    const p = PARTS[z.partId];
    $("infoTitle").textContent = p.nom;
    $("infoText").textContent =
      (p.role || "") +
      (p.desc ? " ‚Äî " + p.desc : "");
    return;
  }

  // fallback (zone non associ√©e)
  $("infoTitle").textContent = z.nom || "Zone";
  $("infoText").textContent =
    (z.role || "") +
    (z.desc ? " ‚Äî " + z.desc : "");
}
function selectObj(obj){
  if(!obj || !obj.zoneData) return;

  selected = obj;
  canvas.setActiveObject(obj);

  fillEditorFields(obj.zoneData);
  showInfo(obj.zoneData);

  applyMode();
}

function clearSelection(){
  selected = null;
  canvas.discardActiveObject();
  fillEditorFields(null);
  showInfo(null);
  applyMode();
}

/* =========================
   MENU (robuste iOS)
========================= */
function togglePanel(){
  const p = $("panel");
  p.style.display = (p.style.display === "block") ? "none" : "block";
}

$("fab").addEventListener("click", (e)=>{
  e.preventDefault();
  e.stopPropagation();
  togglePanel();
});

$("btnShowMedia").addEventListener("click", ()=>{
  if(!selected || !selected.zoneData || !selected.zoneData.partId) return;

  const part = PARTS[selected.zoneData.partId];
  if(!part || !part.medias) return;

  const box = $("mediaContent");
  box.innerHTML = "";

  /* IMAGES */
  (part.medias.images || []).forEach(src=>{
    const d = document.createElement("div");
    d.className = "mediaBlock";
    d.innerHTML = `<img src="${src}" loading="lazy">`;
    box.appendChild(d);
  });

  /* VID√âOS */
  (part.medias.videos || []).forEach(src=>{
    const d = document.createElement("div");
    d.className = "mediaBlock";

    if(src.includes("youtube")){
      d.innerHTML = `
        <iframe src="${src}"
          frameborder="0"
          allowfullscreen
          loading="lazy"></iframe>`;
    }else{
      d.innerHTML = `
        <video src="${src}" controls></video>`;
    }

    box.appendChild(d);
  });

  $("mediaViewer").style.display = "block";
});

$("btnCloseMedia").addEventListener("click", ()=>{
  $("mediaViewer").style.display = "none";
});

/* =========================
   EDITOR ON/OFF
========================= */
$("btnEditor").addEventListener("click", ()=>{
  const p = ($("pw").value || "").trim();
  if(p !== EDITOR_PASSWORD){
    alert("Mot de passe incorrect.");
    return;
  }

  $("pw").value = "";
  isEditor = true;
  tool = "move";
  setUI();
});

$("btnExit").addEventListener("click", ()=>{
  isEditor = false;
  tool = "view";
  clearSelection();
  setUI();
});

$("btnMove").addEventListener("click", ()=>{ if(!isEditor) return; tool="move"; setUI(); }, { passive:false });
$("btnResize").addEventListener("click", ()=>{ if(!isEditor) return; tool="resize"; setUI(); }, { passive:false });
$("btnDraw").addEventListener("click", ()=>{ if(!isEditor) return; tool="draw"; clearSelection(); setUI(); }, { passive:false });

/* =========================
   APPLY / DELETE
========================= */
$("btnApply").addEventListener("click", ()=>{
  if(!isEditor || !selected || !selected.zoneData) return;

  selected.zoneData.nom  = $("editNom").value.trim();
  selected.zoneData.role = $("editRole").value.trim();
  selected.zoneData.desc = $("editDesc").value.trim();

  showInfo(selected.zoneData);
  saveToLocal();
  applyMode();
}, { passive:false });

$("btnDelete").addEventListener("click", ()=>{
  if(!isEditor || !selected || !selected.zoneData) return;

  // retirer du canvas
  canvas.remove(selected);

  // retirer des donn√©es
  zonesData = zonesData.filter(z => z !== selected.zoneData);

  clearSelection();
  saveToLocal();
}, { passive:false });


$("btnLinkPart").addEventListener("click", ()=>{
  if(!isEditor || !selected || !selected.zoneData) return;

  const select = $("partSelect");
  let partId = select.value;

  /* ===== CAS 1 : cr√©ation nouvelle pi√®ce ===== */
  if(partId === "__new__"){
    const nom = prompt("Nom de la nouvelle pi√®ce :");
    if(!nom) return;

    const role = prompt("R√¥le de la pi√®ce :", "");
    const desc = prompt("Description :", "");

    // id technique propre
    partId = nom
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^a-z0-9]+/g,"_")
      .replace(/^_|_$/g,"");

    // s√©curit√© anti-duplication
    if(PARTS[partId]){
      alert("Une pi√®ce avec ce nom existe d√©j√†.");
      return;
    }

    const newPart = {
      id: partId,
      nom,
      role,
      desc
    };

    // ajout en m√©moire
    PARTS[partId] = newPart;
    PARTS_LIST.push(newPart);

    // ajout imm√©diat au menu
    const opt = document.createElement("option");
    opt.value = partId;
    opt.textContent = nom;
    select.appendChild(opt);
    select.value = partId;
  }

  /* ===== CAS 2 : pi√®ce existante ===== */
  if(!PARTS[partId]){
    alert("Choisis une pi√®ce valide.");
    return;
  }

  // üîó lier zone ‚Üí pi√®ce
  selected.zoneData.partId = partId;

  // üí° affichage √©l√®ve
  showInfo(selected.zoneData);

  saveToLocal();
  applyMode();
}, { passive:false });




/* =========================
   EXPORT JSON (download + fallback prompt)
========================= */
function exportZonesJSON(){
  const data = zonesData.map(z => ({
    partId: z.partId || z.id,
    x: z.x,
    y: z.y,
    w: z.w,
    h: z.h
  }));

  const json = JSON.stringify(data, null, 2);

  try{
    const blob = new Blob([json], { type:"application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "zones_mobile.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    setTimeout(()=>URL.revokeObjectURL(url), 250);
  }catch(e){
    prompt("Copie-colle ce JSON :", json);
  }
}

$("btnExport").addEventListener("click", (e)=>{
  e.preventDefault();
  e.stopPropagation();
  exportZonesJSON();
});

/* =========================
   FABRIC EVENTS: select / move / resize / draw
========================= */
canvas.on("mouse:down", opt => {
  const obj = opt.target;

  // DRAW
  if(isEditor && tool === "draw"){
    drawing = true;
    startPt = canvas.getPointer(opt.e);

    tempRect = new fabric.Rect({
      left: startPt.x,
      top: startPt.y,
      width: 2,
      height: 2,
      fill: "rgba(255,255,255,0.10)",
      stroke: "#00a2ff",
      strokeWidth: 3,
      selectable:false,
      evented:false
    });

    canvas.add(tempRect);
    canvas.requestRenderAll();
    return;
  }

  // SELECT (√©diteur ou √©l√®ve)
  if(obj){
    selectObj(obj);
  }else{
    clearSelection();
  }
});

canvas.on("mouse:move", opt => {
  if(!(drawing && tempRect)) return;
  const p = canvas.getPointer(opt.e);

  const left = Math.min(startPt.x, p.x);
  const top  = Math.min(startPt.y, p.y);
  const w = Math.abs(p.x - startPt.x);
  const h = Math.abs(p.y - startPt.y);

  tempRect.set({ left, top, width:Math.max(2,w), height:Math.max(2,h) });
  tempRect.setCoords();
  canvas.requestRenderAll();
});

canvas.on("mouse:up", () => {
  if(!(drawing && tempRect)) return;
  drawing = false;

  const r = tempRect;
  canvas.remove(tempRect);
  tempRect = null;

  if(r.width < 12 || r.height < 12) return;

  // cr√©ation ‚Äúpropre‚Äù sans casser menu
  const id = "zone_" + Date.now();
  const z = {
    id,
    x: Math.round(r.left),
    y: Math.round(r.top),
    w: Math.round(r.width),
    h: Math.round(r.height),
    nom:"",
    role:"",
    desc:""
  };

  zonesData.push(z);

  const rect = makeRectFromZone(z);
  canvas.add(rect);

  // s√©lectionner + remplir inputs
  selectObj(rect);

  // repasser en move (plus agr√©able)
  tool = "move";
  setUI();

  saveToLocal();
});

/* Synchroniser coords lors d‚Äôun drag/resize */
canvas.on("object:modified", e => {
  if(!isEditor) return;
  const o = e.target;
  if(!o || !o.zoneData) return;

  // update data (source de v√©rit√©)
  const z = o.zoneData;
  z.x = Math.round(o.left);
  z.y = Math.round(o.top);
  z.w = Math.round(o.width  * o.scaleX);
  z.h = Math.round(o.height * o.scaleY);

  // reset scale pour garder chiffres propres
  o.set({ scaleX:1, scaleY:1, width:z.w, height:z.h, left:z.x, top:z.y });
  o.setCoords();

  saveToLocal();
});

/* Emp√™che ‚Äúscroll page‚Äù si tu glisses sur canvas (iOS) */
canvas.upperCanvasEl.addEventListener("touchmove", e=>{
  e.preventDefault();
}, { passive:false });

setUI();
</script>
<div id="mediaViewer" style="
  position:fixed;
  inset:0;
  background:#050b24;
  display:none;
  z-index:20000;
  overflow-y:auto;
  padding:16px;
">

  <button id="btnCloseMedia" class="btn" style="margin-bottom:12px;">
    ‚ùå Fermer
  </button>

  <div id="mediaContent"></div>
</div>
</body>
</html>