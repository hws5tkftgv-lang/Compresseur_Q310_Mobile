<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Q310 ‚Äì iPhone √âditeur</title>

<script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>

<style>
html, body{
  margin:0;
  height:100%;
  overflow:hidden;
  background:#0b1436;
  color:#eaf1ff;
  font-family:Arial,Segoe UI,sans-serif;
}
#infoPanel{padding:10px;background:#0f1a44;border-bottom:1px solid rgba(255,255,255,.15);}
#infoTitle{font-size:18px;font-weight:800;}

.stage{position:relative;height:calc(100dvh - 120px);overflow:hidden;background:#0b1536;}
.media-layer,canvas{position:absolute;inset:0;}
#imgLayer{width:100%;height:100%;object-fit:contain;pointer-events:none;}

.stage,.canvas-container,canvas{touch-action:none !important;}

#fab{
  position:fixed;bottom:10px;left:10px;width:46px;height:46px;border-radius:10px;
  background:#ffffff22;border:1px solid #ffffff55;color:#fff;font-size:22px;z-index:9999;
}

#panel{
  position:fixed;
  left:10px;
  bottom:70px;
  width:calc(100vw - 20px);
  max-height:65vh;
  overflow-y:auto;
  overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
  background:#0f1a44;
  border:1px solid rgba(255,255,255,.2);
  padding:10px;
  border-radius:12px;
  display:none;
  z-index:10000;
}

.sectionTitle{
  margin-top:12px;
  font-size:12px;
  opacity:.7;
  font-weight:700;
  text-transform:uppercase;
}
.btn{
  width:100%;min-height:44px;margin-top:8px;background:#1b2553;color:#fff;
  border:1px solid rgba(255,255,255,.2);border-radius:10px;font-size:15px;font-weight:800;
}
.btn.active{background:#ff9800;color:#000;}

.input{
  width:100%;min-height:44px;margin-top:8px;background:#101a40;color:#fff;
  border:1px solid rgba(255,255,255,.2);border-radius:10px;font-size:15px;
  padding:10px;box-sizing:border-box;
}

.small{font-size:12px;opacity:.85;line-height:1.35;margin-top:8px;}


</style>
</head>

<body>

<!-- ===== Bande info √©l√®ve ===== -->
<div id="infoPanel">
  <div id="infoTitle">S√©lectionne une zone</div>
  <div id="infoText" style="font-size:14px; opacity:.9; margin-top:4px;"></div>
</div>

<!-- ===== Zone image + canvas ===== -->
<div class="stage" id="stage">
  <div class="media-layer">
    <img id="imgLayer" src="actif/compresseur_bg.png" alt="">
  </div>
  <canvas id="c"></canvas>
</div>

<!-- ===== Bouton menu flottant ===== -->
<button id="fab">‚ò∞</button>

<!-- ===== MENU UNIQUE ===== -->
<div id="panel">

  <div style="font-weight:900;margin-bottom:6px;">üß∞ Menu</div>

  <!-- √âtat -->
  <div id="stateLine" style="font-weight:900;opacity:.9;">MODE √âL√àVE</div>

  <!-- Connexion √©diteur -->
  <input id="pw" class="input" type="password" placeholder="Mot de passe √©diteur (comp)">
  <button id="btnEditor" class="btn">üîí Activer √©diteur</button>
  <button id="btnExit" class="btn" style="display:none;">üö™ Quitter √©diteur</button>

  <!-- ===== OUTILS ===== -->
  <div class="sectionTitle">Outils</div>
  <button id="btnMove" class="btn" disabled>‚úã D√©placer</button>
  <button id="btnResize" class="btn" disabled>‚¨ç Redimensionner</button>
  <button id="btnDraw" class="btn" disabled>‚ûï Nouvelle zone</button>

  <!-- ===== √âDITION ZONE ===== -->
  <div class="sectionTitle">Zone s√©lectionn√©e</div>
  <input id="editNom" class="input" placeholder="Nom">
  <textarea id="editRole" class="input" placeholder="R√¥le"></textarea>
  <textarea id="editDesc" class="input" placeholder="Description"></textarea>

  <button id="btnApply" class="btn">üíæ Appliquer</button>
  <button id="btnDelete" class="btn">üóëÔ∏è Supprimer la zone</button>

  <!-- ===== SAUVEGARDE ===== -->
  <div class="sectionTitle">Sauvegarde</div>
  <button id="btnExport" class="btn">üì§ Export JSON</button>

</div>

<!-- ===== Badge √©diteur ===== -->
<div id="editorState"
     style="position:fixed;top:10px;left:10px;
            background:#ff9800;color:#000;
            padding:6px 10px;border-radius:8px;
            font-weight:900;z-index:9999;
            display:none;">
  ‚úèÔ∏è MODE √âDITEUR
</div>

<script>
/* ================== CONFIG ================== */
const EDITOR_PASSWORD = "comp";
const $ = id => document.getElementById(id);

/* ================== √âTAT ================== */
let isEditor = false;
let tool = "view"; // view | move | resize | draw
let selected = null;
let drawing = false;
let start = null;
let tempRect = null;

/* ================== CANVAS ================== */
const canvas = new fabric.Canvas("c", { selection:false });
canvas.preserveObjectStacking = true;
canvas.selection = false;

/* iOS SAFE */
canvas.upperCanvasEl.style.touchAction = "none";

/* Ergonomie tactile */
fabric.Object.prototype.cornerSize = 36;
fabric.Object.prototype.cornerStyle = "circle";
fabric.Object.prototype.transparentCorners = false;
fabric.Object.prototype.targetFindTolerance = 40;

/* ================== UI ================== */
function setUI(){
  $("editorState").style.display = isEditor ? "block" : "none";
  $("stateLine").textContent = isEditor ? "MODE √âDITEUR" : "MODE √âL√àVE";

  $("btnEditor").style.display = isEditor ? "none" : "block";
  $("btnExit").style.display   = isEditor ? "block" : "none";

  ["btnMove","btnResize","btnDraw"].forEach(id=>{
    $(id).disabled = !isEditor;
  });

  applyMode();
}

function applyMode(){
  canvas.forEachObject(o=>{
    o.evented = false;
    o.selectable = false;
    o.hasControls = false;
    o.hasBorders = false;

    if(isEditor){
      o.evented = true;

      if(tool === "move"){
        o.selectable = true;
        o.hasBorders = true;
      }
      if(tool === "resize"){
        o.selectable = true;
        o.hasBorders = true;
        o.hasControls = true;
      }
    }
  });
  canvas.requestRenderAll();
}

/* ================== MENU ================== */
["click","touchend"].forEach(evt=>{
  $("fab").addEventListener(evt, e=>{
    e.preventDefault();
    e.stopPropagation();
    $("panel").style.display =
      $("panel").style.display === "block" ? "none" : "block";
  }, { passive:false });
});

/* ================== MODE √âDITEUR ================== */
$("btnEditor").onclick = ()=>{
  if(($("pw").value||"").trim() !== EDITOR_PASSWORD){
    alert("Mot de passe incorrect");
    return;
  }
  isEditor = true;
  tool = "move";
  setUI();
};

$("btnExit").onclick = ()=>{
  isEditor = false;
  tool = "view";
  clearSelection();
  setUI();
};

/* ================== OUTILS ================== */
$("btnMove").onclick   = ()=>{ if(isEditor){ tool="move"; applyMode(); }};
$("btnResize").onclick = ()=>{ if(isEditor){ tool="resize"; applyMode(); }};
$("btnDraw").onclick   = ()=>{ if(isEditor){ tool="draw"; clearSelection(); applyMode(); }};

/* ================== S√âLECTION ================== */
function selectObj(o){
  if(!o || !o.zoneData) return;
  clearSelection();
  selected = o;
  o.set({ stroke:"orange", strokeWidth:4 });
  canvas.setActiveObject(o);

  $("infoTitle").textContent = o.zoneData.nom;
  $("infoText").textContent  =
    (o.zoneData.role||"") +
    (o.zoneData.desc ? " ‚Äî "+o.zoneData.desc : "");

  canvas.requestRenderAll();
}

function clearSelection(){
  if(!selected) return;
  selected.set({ stroke:"white", strokeWidth:3 });
  selected = null;
  canvas.discardActiveObject();
}

/* ================== DESSIN ZONE ================== */
canvas.on("mouse:down", opt=>{
  if(isEditor && tool==="draw"){
    drawing = true;
    start = canvas.getPointer(opt.e);
    tempRect = new fabric.Rect({
      left:start.x, top:start.y,
      width:2, height:2,
      fill:"rgba(255,255,255,0.1)",
      stroke:"#00a2ff", strokeWidth:3,
      selectable:false, evented:false
    });
    canvas.add(tempRect);
  }
  else if(opt.target){
    selectObj(opt.target);
  } else {
    clearSelection();
    $("infoTitle").textContent = "S√©lectionne une zone";
    $("infoText").textContent = "";
  }
});

canvas.on("mouse:move", opt=>{
  if(!drawing || !tempRect) return;
  const p = canvas.getPointer(opt.e);
  tempRect.set({
    left:Math.min(start.x,p.x),
    top: Math.min(start.y,p.y),
    width:Math.abs(p.x-start.x),
    height:Math.abs(p.y-start.y)
  });
  tempRect.setCoords();
  canvas.requestRenderAll();
});

canvas.on("mouse:up", ()=>{
  if(!drawing || !tempRect) return;
  drawing = false;

  if(tempRect.width < 12 || tempRect.height < 12){
    canvas.remove(tempRect);
    tempRect = null;
    return;
  }

  const nom  = prompt("Nom de la zone ?");
  if(!nom){ canvas.remove(tempRect); return; }
  const role = prompt("R√¥le ?");
  const desc = prompt("Description ?");

  const zoneData = {
    id:"zone_"+Date.now(),
    nom, role, desc
  };

  const zone = new fabric.Rect({
    left:tempRect.left,
    top:tempRect.top,
    width:tempRect.width,
    height:tempRect.height,
    fill:"rgba(255,255,255,0.08)",
    stroke:"white", strokeWidth:3,
    lockRotation:true
  });

  zone.zoneId = zoneData.id;
  zone.zoneData = zoneData;

  canvas.remove(tempRect);
  tempRect = null;

  canvas.add(zone);
  selectObj(zone);
  applyMode();
});

/* ================== EXPORT JSON ================== */
function exportZonesJSON(){
  const data = [];
  canvas.getObjects().forEach(o=>{
    if(!o.zoneId) return;
    data.push({
      id:o.zoneId,
      x:Math.round(o.left),
      y:Math.round(o.top),
      w:Math.round(o.width * o.scaleX),
      h:Math.round(o.height * o.scaleY),
      nom:o.zoneData.nom,
      role:o.zoneData.role,
      desc:o.zoneData.desc
    });
  });

  const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "zones.json";
  a.click();
  URL.revokeObjectURL(url);
}

$("btnExport").addEventListener("click", exportZonesJSON, {passive:false});
</script>
</body>
</html>