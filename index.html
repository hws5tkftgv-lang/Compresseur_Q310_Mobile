<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Q310 ‚Äì iPhone √âditeur (FINAL STABLE iOS Safari)</title>

  <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>

  <style>
    :root{
      --quickbar-h: 70px;
      --header-h: 86px;      /* sera recalcul√© en JS */
      --vvh: 100vh;          /* visualViewport height */
      --safari-ui: 0px;      /* overlay bas Safari */
    }

    html, body{
      margin:0;
      padding:0;
      width:100%;
      height:100%;
      overflow:hidden;
      overscroll-behavior:none;
      background:#0b1436;
      color:#eaf1ff;
      font-family:Arial,Segoe UI,sans-serif;
      -webkit-text-size-adjust:100%;
      touch-action:none;
    }
    body{ position:fixed; inset:0; }

    #app{
      position:fixed;
      inset:0;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      background:#0b1436;

      padding-bottom: calc(
        var(--quickbar-h)
        + env(safe-area-inset-bottom)
        + var(--safari-ui)
      );
    }

    /* ===== Bande info ===== */
    #infoPanel{
      padding:10px 12px;
      background:#0f1a44;
      border-bottom:1px solid rgba(255,255,255,.15);
      flex:0 0 auto;
      position:relative;
      z-index:5;

      width:100%;
      box-sizing:border-box;
      overflow:hidden;
    }

    #infoTitle{
      font-size:16px;
      font-weight:800;
      line-height:1.25;
      white-space:normal;
      word-break:break-word;
      padding-right:44px; /* place pour ‚úèÔ∏è */
    }

    #infoText{
      font-size:13px;
      opacity:.9;
      margin-top:4px;
      line-height:1.3;
      white-space:normal;
      word-break:break-word;
    }

    /* ‚úèÔ∏è badge */
    #editorState{
      position:absolute;
      top:8px;
      right:8px;
      width:32px;
      height:32px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#ff9800;
      color:#000;
      font-size:16px;
      font-weight:900;
      z-index:20;
      pointer-events:none;
    }

    /* ===== Stage ===== */
    .stage{
      position:relative;
      width:100%;
      height: calc(
        var(--vvh)
        - var(--header-h)
        - var(--quickbar-h)
        - env(safe-area-inset-bottom)
        - var(--safari-ui)
      );
      overflow:hidden;
      background:#000;
      touch-action:none;
    }

    .media-layer,
    .canvas-wrap{
      position:absolute;
      inset:0;
    }

    #imgLayer{
      position:absolute;
      left:0;
      top:0;
      width:0;
      height:0;
      object-fit:contain;
      pointer-events:none;
      user-select:none;
      -webkit-user-drag:none;
    }

    .canvas-container, canvas{
      touch-action:none !important;
    }

    /* ===== Quickbar ===== */
    #quickbar{
      position:fixed;
      left:0;
      right:0;
      bottom: var(--safari-ui);

      height: calc(var(--quickbar-h) + env(safe-area-inset-bottom));
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom)) 10px;

      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;

      background:rgba(15,26,68,.95);
      backdrop-filter:blur(10px);
      border-top:1px solid rgba(255,255,255,.15);
      z-index:10000;
      touch-action:none;
    }

    .qbtn{
      width:46px;
      height:46px;
      border-radius:10px;
      background:#1b2553;
      color:#fff;
      border:1px solid rgba(255,255,255,.25);
      font-size:18px;
      font-weight:900;
    }
    .qbtn.active{ background:#ff9800; color:#000; }

    /* ===== Inputs / buttons ===== */
    .btn{
      width:100%;
      min-height:44px;
      margin-top:8px;
      background:#1b2553;
      color:#fff;
      border:1px solid rgba(255,255,255,.2);
      border-radius:10px;
      font-size:15px;
      font-weight:800;
    }
    .input{
      width:100%;
      min-height:44px;
      margin-top:8px;
      background:#101a40;
      color:#fff;
      border:1px solid rgba(255,255,255,.2);
      border-radius:10px;
      font-size:15px;
      padding:10px;
      box-sizing:border-box;
    }
    .sectionTitle{
      margin-top:12px;
      font-size:12px;
      opacity:.7;
      font-weight:700;
      text-transform:uppercase;
    }

    /* ===== Panneau Pi√®ce & m√©dias ===== */
    #piecePanel{
      position:fixed;
      inset:0;
      background:#0f1a44;
      z-index:20000;
      display:none;
      flex-direction:column;
      touch-action:none;
    }
    #piecePanel.open{ display:flex; }

    .panelHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 16px;
      font-weight:900;
      border-bottom:1px solid rgba(255,255,255,.15);
      flex:0 0 auto;
    }
    .panelHeader button{
      background:none;
      border:none;
      color:#fff;
      font-size:22px;
      font-weight:900;
    }
    .panelContent{
      padding:16px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      flex:1 1 auto;
      touch-action:pan-y;
    }
    .panelLabel{
      font-size:12px;
      opacity:.7;
      margin-bottom:6px;
      display:block;
    }

    /* ===== Viewer m√©dias ===== */
    #mediaViewer{
      position:fixed;
      inset:0;
      background:#050b24;
      z-index:30000;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding:16px 16px calc(16px + env(safe-area-inset-bottom)) 16px;
      display:none;
      pointer-events:none;
      touch-action:pan-y;
    }
    #mediaViewer.open{
      display:block;
      pointer-events:auto;
    }
    .mediaBlock{ margin-bottom:20px; }
    .mediaBlock img,
    .mediaBlock iframe,
    .mediaBlock video{
      width:100%;
      border-radius:12px;
      background:#000;
    }
  </style>
</head>

<body>

  <div id="app">
    <div id="infoPanel">
      <div id="infoTitle">S√©lectionne une zone</div>
      <div id="infoText"></div>
      <div id="editorState">‚úèÔ∏è</div>
    </div>

    <div class="stage" id="stage">
  <div class="media-layer" id="mediaLayer">
  <img id="imgLayer" src="actif/compresseur_bg.png" alt="">
</div>
<div class="canvas-wrap" id="canvasWrap">
  <canvas id="c"></canvas>
</div>
    </div>
  </div>

  <!-- Quickbar -->
  <div id="quickbar">
    <button id="btnMove" class="qbtn active" title="D√©placer">‚úã</button>
    <button id="btnDraw" class="qbtn" title="Dessiner">Ôºã</button>
    <button id="btnResize" class="qbtn" title="Redimensionner">‚Üï</button>
    <button id="btnDelete" class="qbtn" title="Supprimer">üóëÔ∏è</button>
    <button id="btnIO" class="qbtn" title="Import/Export">‚áÑ</button>
    <button id="btnPiece" class="qbtn" title="Pi√®ce/M√©dias">üì¶</button>
    <button id="btnViewMenu" class="qbtn" title="Vue active">üñºÔ∏è</button>
    <input type="file" id="fileInput" accept="application/json" hidden>
  </div>

  <!-- Panneau pi√®ce & m√©dias -->
  <div id="piecePanel">
    <div class="panelHeader">
      <span>üì¶ Pi√®ce & m√©dias</span>
      <button id="btnClosePiecePanel">‚úï</button>
    </div>

    <div class="panelContent">
      <label class="panelLabel">Associer une pi√®ce</label>
      <select id="partSelect" class="input">
        <option value="">‚Äî Choisir une pi√®ce ‚Äî</option>
        <option value="__new__">‚ûï Nouvelle pi√®ce‚Ä¶</option>
      </select>

      <button id="btnShowMedia" class="btn">üñºÔ∏èüé• Voir les m√©dias</button>
      <div class="sectionTitle">Ajouter depuis actif/</div>
<div class="sectionTitle">Changer de vue</div>
<button id="btnViewMenu" class="qbtn" title="Changer de vue">üñºÔ∏è</button>
      <button id="btnAddImage" class="btn">‚ûï Ajouter une image</button>
      <button id="btnAddVideo" class="btn">‚ûï Ajouter une vid√©o</button>
    </div>
  </div>

  <!-- Viewer m√©dias -->
  <div id="mediaViewer">
    <button id="btnCloseMedia" class="btn" style="margin-bottom:12px;">‚ùå Fermer</button>
    <div id="mediaContent"></div>
  </div>

<script>
/* =========================================================
   HELPERS
   ========================================================= */
const $ = id => document.getElementById(id);

/* ‚úÖ Autoriser scroll uniquement dans panneaux */
function allowScrollTarget(el){
  return !!(el && (el.closest(".panelContent") || el.closest("#mediaViewer")));
}
document.addEventListener("touchmove", (e)=>{
  if(!allowScrollTarget(e.target)) e.preventDefault();
}, { passive:false });

/* =========================================================
   VIEWPORT VARS (source unique)
   ========================================================= */
function updateViewportVars(){
  const vv = window.visualViewport;
  const vvh = vv ? vv.height : window.innerHeight;
  const safariUI = vv
    ? Math.max(0, window.innerHeight - (vv.height + vv.offsetTop))
    : 0;

  document.documentElement.style.setProperty("--vvh", Math.round(vvh) + "px");
  document.documentElement.style.setProperty("--safari-ui", Math.round(safariUI) + "px");

  // Header dynamique: on mesure vraiment la hauteur du bandeau
  const header = $("infoPanel");
  if(header){
    const h = header.getBoundingClientRect().height;
    document.documentElement.style.setProperty("--header-h", Math.round(h) + "px");
  }
}

/* =========================================================
   ORCHESTRATEUR STABLE (anti-drift iOS)
   ========================================================= */
let relayoutTimer = null;
function scheduleRelayout(delay = 250){
  if(relayoutTimer) clearTimeout(relayoutTimer);
  relayoutTimer = setTimeout(() => {
    updateViewportVars();
    fitCanvasToImage();
  }, delay);
}

/* =========================================================
   ASSETS / STORAGE
   ========================================================= */
const ASSETS = {
  images: [
    "actif/VUE_GENERAL.jpeg",
    "actif/VUE_GENERAL_2.jpeg",
    "actif/VUE_1.jpeg",
    "actif/VUE_POMPE.jpeg",
    "actif/TETE.jpeg",
    "actif/TETE_2.jpeg",
    "actif/POULIE.jpeg",
    "actif/FILTRE_AIR_COUVERCLE.jpeg",
    "actif/LOAD_SIDE.jpeg",
    "actif/SOUPAPE_UNLOADER.jpeg",
    "actif/TOP.jpeg",
    "actif/VERS_RESERVOIR.jpeg"
  ],
  videos: [
    "actif/compresseur_2_stages.mp4"
  ]
};


const VIEWS_CATALOG = [
  { id:"vue_generale", label:"Vue g√©n√©rale", src:"actif/VUE_GENERAL.jpeg", type:"image" },
  { id:"vue_generale_2", label:"Vue g√©n√©rale 2", src:"actif/VUE_GENERAL_2.jpeg", type:"image" },
  { id:"vue_pompe", label:"Vue pompe", src:"actif/VUE_POMPE.jpeg", type:"image" },
  { id:"vue_tete", label:"T√™te", src:"actif/TETE.jpeg", type:"image" },
  { id:"vue_tete_2", label:"T√™te (d√©tail)", src:"actif/TETE_2.jpeg", type:"image" },
  { id:"vue_poulie", label:"Poulie", src:"actif/POULIE.jpeg", type:"image" },
  { id:"vue_filtre", label:"Filtre √† air", src:"actif/FILTRE_AIR_COUVERCLE.jpeg", type:"image" },
  { id:"vue_side", label:"C√¥t√© charge", src:"actif/LOAD_SIDE.jpeg", type:"image" },
  { id:"vue_unloader", label:"Soupape unloader", src:"actif/SOUPAPE_UNLOADER.jpeg", type:"image" },
  { id:"vue_top", label:"Vue du dessus", src:"actif/TOP.jpeg", type:"image" },
  { id:"vue_reservoir", label:"Vers r√©servoir", src:"actif/VERS_RESERVOIR.jpeg", type:"image" },

  { id:"video_global", label:"Vid√©o ‚Äì compresseur", src:"actif/compresseur_2_stages.mp4", type:"video" }
];



const STORAGE_KEY = "q310_views_v1"; // ‚úÖ nouveau storage
const PARTS_STORAGE_KEY = "q310_parts_v1";

function getCurrentImageKey(){
  const img = $("imgLayer");
  const src = (img && img.getAttribute("src")) ? img.getAttribute("src") : "";
  const base = src.split("?")[0].split("#")[0].split("/").pop();
  return base || "compresseur_bg.png";
}

let currentViewId = getCurrentImageKey(); // ex: compresseur_bg.png
let VIEWS = {};  // { [viewId]: { id, type, src, zones, linkedFromZone } }
let zonesData = []; // alias = zones de la vue courante

let PARTS = {};
let PARTS_LIST = [];

/* =========================================================
   PARTS load/save
   ========================================================= */
function savePartsToLocal(){
  try{ localStorage.setItem(PARTS_STORAGE_KEY, JSON.stringify(PARTS_LIST)); }
  catch(e){ console.error("savePartsToLocal error", e); }
}

function loadPartsFromLocal(){
  try{
    const raw = localStorage.getItem(PARTS_STORAGE_KEY);
    if(!raw) return false;
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return false;

    PARTS_LIST = arr;
    PARTS = {};
    PARTS_LIST.forEach(p => { if(p && p.id) PARTS[p.id] = p; });
    return true;
  }catch(e){
    return false;
  }
}

function remplirMenuPieces(){
  const select = $("partSelect");
  if(!select) return;

  select.innerHTML = `
    <option value="">‚Äî Choisir une pi√®ce ‚Äî</option>
    <option value="__new__">‚ûï Nouvelle pi√®ce‚Ä¶</option>
  `;

  PARTS_LIST.forEach(p => {
    if(!p || !p.id) return;
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = `${p.nom || p.id} (${p.circuit || "?"})`;
    select.appendChild(opt);
  });
}

(function initParts(){
  if(loadPartsFromLocal()){
    remplirMenuPieces();
    return;
  }
  fetch("quincy_310L_parts.json")
    .then(res => res.json())
    .then(data => {
      PARTS_LIST = Array.isArray(data) ? data : [];
      PARTS = {};
      PARTS_LIST.forEach(p => { if(p && p.id) PARTS[p.id] = p; });
      savePartsToLocal();
      remplirMenuPieces();
    })
    .catch(err => console.error("Erreur chargement quincy_310L_parts.json", err));
})();

/* =========================================================
   FABRIC init
   ========================================================= */
let isEditor = true;
let tool = "move";
let selected = null;

let drawing = false;
let startPt = null;
let tempRect = null;

const canvas = new fabric.Canvas("c", {
  selection:false,
  preserveObjectStacking:true,
  allowTouchScrolling:false
});
canvas.selection = false;

canvas.upperCanvasEl.style.touchAction = "none";
canvas.upperCanvasEl.style.webkitUserSelect = "none";
canvas.upperCanvasEl.style.webkitTouchCallout = "none";

fabric.Object.prototype.cornerSize = 36;
fabric.Object.prototype.cornerStyle = "circle";
fabric.Object.prototype.transparentCorners = false;
fabric.Object.prototype.padding = 10;
fabric.Object.prototype.perPixelTargetFind = false;
fabric.Object.prototype.targetFindTolerance = 45;

/* =========================================================
   FIT CANVAS TO IMAGE (centrage stable)
   ========================================================= */
function fitCanvasToImage(){
  const img   = $("imgLayer");
  const stage = $("stage");
  if(!img || !stage || !img.naturalWidth) return;

  const r = stage.getBoundingClientRect();
  const stageW = Math.max(1, Math.round(r.width));
  const stageH = Math.max(1, Math.round(r.height));

  const imgW = img.naturalWidth;
  const imgH = img.naturalHeight;

  const scale = Math.min(stageW / imgW, stageH / imgH);
  const w = Math.round(imgW * scale);
  const h = Math.round(imgH * scale);

  const left = Math.round((stageW - w) / 2);
  const top  = Math.round((stageH - h) / 2);

  // Image
  img.style.left   = left + "px";
  img.style.top    = top  + "px";
  img.style.width  = w + "px";
  img.style.height = h + "px";

  // Canvas
  canvas.setWidth(w);
  canvas.setHeight(h);

  const wrap = canvas.wrapperEl;
  if(wrap){
    wrap.style.position = "absolute";
    wrap.style.left   = left + "px";
    wrap.style.top    = top  + "px";
    wrap.style.width  = w + "px";
    wrap.style.height = h + "px";
  }

  canvas.calcOffset();
  canvas.requestRenderAll();
}

/* =========================================================
   ZONES load/save
   ========================================================= */
function saveToLocal(){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(VIEWS));
  }catch(e){
    console.error("Save error", e);
  }
}

function loadFromLocal(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return false;

    const obj = JSON.parse(raw);
    if(!obj || typeof obj !== "object") return false;

    VIEWS = obj;
    return true;
  }catch(e){
    return false;
  }
}

function ensureView(viewId, src){
  if(!VIEWS[viewId]){
    VIEWS[viewId] = {
      id: viewId,
      type: "image",
      src: src,
      zones: [],
      linkedFromZone: null
    };
  }
  zonesData = VIEWS[viewId].zones; // ‚úÖ alias zonesData vers cette vue
}




function makeRectFromZone(z){
  const r = new fabric.Rect({
    left: z.x,
    top: z.y,
    width: z.w,
    height: z.h,
    fill: "rgba(255,255,255,0.08)",
    stroke: "white",
    strokeWidth: 3,
    lockRotation: true
  });
  r.zoneId = z.id;
  r.zoneData = z;
  return r;
}

function bootZones(){
  canvas.clear();

  // 1) charger views depuis local si existe
  const hasLocal = loadFromLocal();

  // 2) d√©finir la vue courante = image affich√©e
  const src = currentViewId;

  // 3) cr√©er la vue si absente
  ensureView(currentViewId, src);

  // 4) si aucune donn√©e locale, cr√©er une zone d√©mo dans la vue courante
  if(!hasLocal && zonesData.length === 0){
    zonesData.push({
      id:"cylindre_lp",
      x:140, y:120, w:120, h:220,
      nom:"Cylindre LP",
      role:"Compression initiale",
      desc:"Premi√®re √©tape de compression.",
      partId:""
    });
    saveToLocal();
  }

  // 5) dessiner zones de la vue courante
  zonesData.forEach(z => canvas.add(makeRectFromZone(z)));

  clearSelection();
  applyMode();
  fitCanvasToImage();
}
/* =========================================================
   UI / Modes / Selection
   ========================================================= */
function updateQuickbar(){
  ["btnMove","btnDraw","btnResize"].forEach(id => $(id).classList.remove("active"));
  if(tool === "move")   $("btnMove").classList.add("active");
  if(tool === "draw")   $("btnDraw").classList.add("active");
  if(tool === "resize") $("btnResize").classList.add("active");
}

function showAllResizeHandles(obj, on){
  obj.setControlsVisibility({
    tl:on, tr:on, bl:on, br:on,
    ml:on, mt:on, mr:on, mb:on,
    mtr:false
  });
}

function applyMode(){
  canvas.forEachObject(o => {
    o.stroke = (o === selected) ? "orange" : "white";
    o.strokeWidth = (o === selected) ? 5 : 3;

    if(!isEditor){
      o.evented = true;
      o.selectable = false;
      o.hasControls = false;
      o.hasBorders = false;

      o.lockMovementX = true;
      o.lockMovementY = true;
      o.lockScalingX  = true;
      o.lockScalingY  = true;
      o.lockRotation  = true;

      showAllResizeHandles(o,false);
      return;
    }

    o.evented = true;
    o.lockRotation = true;

    if(tool === "draw"){
      o.selectable = false;
      o.hasControls = false;
      o.hasBorders = false;
      showAllResizeHandles(o,false);
      return;
    }

    if(tool === "move"){
      o.selectable = true;
      o.hasControls = false;
      o.hasBorders = true;

      o.lockMovementX = false;
      o.lockMovementY = false;
      o.lockScalingX  = true;
      o.lockScalingY  = true;

      showAllResizeHandles(o,false);
      return;
    }

    if(tool === "resize"){
      o.selectable = true;
      o.hasControls = true;
      o.hasBorders = true;

      o.lockMovementX = false;
      o.lockMovementY = false;
      o.lockScalingX  = false;
      o.lockScalingY  = false;

      showAllResizeHandles(o,true);
      return;
    }
  });

  canvas.requestRenderAll();
}

function setUI(){
  $("editorState").style.display = isEditor ? "flex" : "none";

  ["btnMove","btnDraw","btnResize"].forEach(id=>{
    $(id).disabled = !isEditor;
  });

  updateQuickbar();
  applyMode();
}

function setTool(newTool){
  if(!isEditor) return;
  tool = newTool;
  setUI();
}

function showInfo(z){
  if(!z){
    $("infoTitle").textContent = "S√©lectionne une zone";
    $("infoText").textContent = "";
    return;
  }

  if(z.partId && PARTS[z.partId]){
    const p = PARTS[z.partId];
    $("infoTitle").textContent = p.nom || z.partId;
    $("infoText").textContent = (p.role || "") + (p.desc ? " ‚Äî " + p.desc : "");
    return;
  }

  $("infoTitle").textContent = z.nom || "Zone";
  $("infoText").textContent = (z.role || "") + (z.desc ? " ‚Äî " + z.desc : "");
}

function selectObj(obj){
  if(!obj || !obj.zoneData) return;

  selected = obj;
  canvas.setActiveObject(obj);

  $("partSelect").value = selected.zoneData.partId || "";
  showInfo(obj.zoneData);
  applyMode();
}

function clearSelection(){
  selected = null;
  canvas.discardActiveObject();
  showInfo(null);
  applyMode();
}

/* =========================================================
   PANELS
   ========================================================= */
function openPiecePanel(){
  if(!selected) return;
  $("partSelect").value = selected.zoneData.partId || "";
  $("piecePanel").classList.add("open");
}
function closePiecePanel(){ $("piecePanel").classList.remove("open"); }
function openMediaViewer(){ $("mediaViewer").classList.add("open"); }
function closeMediaViewer(){ $("mediaViewer").classList.remove("open"); }

/* =========================================================
   BUTTONS
   ========================================================= */
$("btnMove").addEventListener("click", ()=> setTool("move"));
$("btnDraw").addEventListener("click", ()=> setTool("draw"));
$("btnResize").addEventListener("click", ()=> setTool("resize"));

$("btnPiece").addEventListener("click", openPiecePanel);
$("btnClosePiecePanel").addEventListener("click", closePiecePanel);

$("btnDelete").addEventListener("click", ()=>{
  if(!isEditor || !selected) return;
  if(!confirm("Supprimer cette zone ?")) return;

  canvas.remove(selected);
  zonesData = zonesData.filter(z => z !== selected.zoneData);

  VIEWS[currentViewId].zones = zonesData;
  clearSelection();
  saveToLocal();
});

$("btnIO").addEventListener("click", ()=>{
  const action = prompt("Tape 1 pour EXPORT, 2 pour IMPORT");
  if(action === "1") exportZonesJSON();
  if(action === "2") $("fileInput").click();
});


$("btnViewMenu").addEventListener("click", openViewMenu);

/* =========================================================
   PART SELECT
   ========================================================= */
$("partSelect").addEventListener("change", ()=>{
  if(!selected || !selected.zoneData) return;

  const v = $("partSelect").value;

  if(v === "__new__"){
    const nom = prompt("Nom de la nouvelle pi√®ce ?");
    if(!nom){
      $("partSelect").value = selected.zoneData.partId || "";
      return;
    }

    const baseId = nom.toLowerCase().trim()
      .replace(/\s+/g,"_")
      .replace(/[^a-z0-9_]/g,"");

    const id = baseId ? baseId : ("piece_" + Date.now());
    const newPart = { id, nom, circuit:"", role:"", desc:"", medias:{ images:[], videos:[] } };

    PARTS_LIST.push(newPart);
    PARTS[id] = newPart;

    savePartsToLocal();
    remplirMenuPieces();

    selected.zoneData.partId = id;
    $("partSelect").value = id;
    saveToLocal();
    showInfo(selected.zoneData);
    return;
  }

  selected.zoneData.partId = v || "";
  saveToLocal();
  showInfo(selected.zoneData);
});

/* =========================================================
   MEDIA VIEWER
   ========================================================= */
$("btnShowMedia").addEventListener("click", ()=>{
  if(!selected || !selected.zoneData || !selected.zoneData.partId) return;

  const part = PARTS[selected.zoneData.partId];
  if(!part || !part.medias){
    alert("Aucun m√©dia pour cette pi√®ce.");
    return;
  }

  const box = $("mediaContent");
  box.innerHTML = "";

  (part.medias.images || []).forEach(src=>{
    const d = document.createElement("div");
    d.className = "mediaBlock";
    d.innerHTML = `<img src="${src}" loading="lazy" alt="">`;
    box.appendChild(d);
  });

  (part.medias.videos || []).forEach(src=>{
    const d = document.createElement("div");
    d.className = "mediaBlock";
    d.innerHTML = (src.includes("youtube"))
      ? `<iframe src="${src}" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`
      : `<video src="${src}" controls playsinline preload="metadata"></video>`;
    box.appendChild(d);
  });

  openMediaViewer();
});

$("btnCloseMedia").addEventListener("click", closeMediaViewer);

$("btnAddImage").addEventListener("click", ()=>{
  if(!selected) return alert("S√©lectionne une zone d‚Äôabord.");
  if(!selected.zoneData?.partId) return alert("Associe une pi√®ce √† la zone avant d‚Äôajouter des m√©dias.");

  const part = PARTS[selected.zoneData.partId];
  if(!part.medias) part.medias = { images:[], videos:[] };

  const choix = prompt("Choisis une image :\n\n" + ASSETS.images.map((p,i)=>`${i+1}. ${p}`).join("\n"));
  const idx = parseInt(choix,10) - 1;
  if(isNaN(idx) || !ASSETS.images[idx]) return;

  part.medias.images.push(ASSETS.images[idx]);
  savePartsToLocal();
  saveToLocal();

  alert("Image ajout√©e √† la pi√®ce");
});

$("btnAddVideo").addEventListener("click", ()=>{
  if(!selected) return alert("S√©lectionne une zone d‚Äôabord.");
  if(!selected.zoneData?.partId) return alert("Associe une pi√®ce √† la zone avant d‚Äôajouter des m√©dias.");

  const part = PARTS[selected.zoneData.partId];
  if(!part.medias) part.medias = { images:[], videos:[] };

  const choix = prompt("Choisis une vid√©o :\n\n" + ASSETS.videos.map((p,i)=>`${i+1}. ${p}`).join("\n"));
  const idx = parseInt(choix,10) - 1;
  if(isNaN(idx) || !ASSETS.videos[idx]) return;

  part.medias.videos.push(ASSETS.videos[idx]);
  savePartsToLocal();
  saveToLocal();

  alert("Vid√©o ajout√©e √† la pi√®ce");
});

/* =========================================================
   IMPORT / EXPORT
   ========================================================= */
$("fileInput").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = ev=>{
    try{
      const data = JSON.parse(ev.target.result);
      if(!Array.isArray(data)) throw new Error("format invalide");

      zonesData = data.map(z=>({
        id: ("zone_" + Date.now() + "_" + Math.floor(Math.random()*100000)),
        x: Number(z.x)||0,
        y: Number(z.y)||0,
        w: Number(z.w)||20,
        h: Number(z.h)||20,
        nom:"",
        role:"",
        desc:"",
        partId: z.partId || ""
      }));

      VIEWS[currentViewId].zones = zonesData;

      canvas.clear();
      zonesData.forEach(z=>canvas.add(makeRectFromZone(z)));

      clearSelection();
      saveToLocal();
      scheduleRelayout(150);

      alert("Import r√©ussi");
    }catch(err){
      alert("JSON invalide");
      console.error(err);
    }
  };
  reader.readAsText(file);
  e.target.value = "";
});

function exportZonesJSON(){
  const data = zonesData.map(z => ({
    partId: z.partId || z.id,
    x: z.x, y: z.y, w: z.w, h: z.h
  }));

  const json = JSON.stringify(data, null, 2);

  try{
    const blob = new Blob([json], { type:"application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "zones_mobile.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    setTimeout(()=>URL.revokeObjectURL(url), 250);
  }catch(e){
    prompt("Copie-colle ce JSON :", json);
  }
}

/* =========================================================
   FABRIC EVENTS (draw/select/resize sync)
   ========================================================= */
canvas.on("mouse:down", opt => {
  const obj = opt.target;

  if(isEditor && tool === "draw"){
    drawing = true;
    startPt = canvas.getPointer(opt.e);

    tempRect = new fabric.Rect({
      left: startPt.x,
      top: startPt.y,
      width: 2,
      height: 2,
      fill: "rgba(255,255,255,0.10)",
      stroke: "#00a2ff",
      strokeWidth: 3,
      selectable:false,
      evented:false
    });

    canvas.add(tempRect);
    canvas.requestRenderAll();
    return;
  }

  if(obj) selectObj(obj);
  else clearSelection();
});

canvas.on("mouse:move", opt => {
  if(!(drawing && tempRect)) return;
  const p = canvas.getPointer(opt.e);

  const left = Math.min(startPt.x, p.x);
  const top  = Math.min(startPt.y, p.y);
  const w = Math.abs(p.x - startPt.x);
  const h = Math.abs(p.y - startPt.y);

  tempRect.set({ left, top, width:Math.max(2,w), height:Math.max(2,h) });
  tempRect.setCoords();
  canvas.requestRenderAll();
});

canvas.on("mouse:up", () => {
  if(!(drawing && tempRect)) return;
  drawing = false;

  const r = tempRect;
  canvas.remove(tempRect);
  tempRect = null;

  const w = r.width || 0;
  const h = r.height || 0;
  if(w < 12 || h < 12) return;

  const id = "zone_" + Date.now();
  const z = {
    id,
    x: Math.round(r.left),
    y: Math.round(r.top),
    w: Math.round(w),
    h: Math.round(h),
    nom:"",
    role:"",
    desc:"",
    partId:""
  };

  zonesData.push(z);
  VIEWS[currentViewId].zones = zonesData;
saveToLocal();
  

  const rect = makeRectFromZone(z);
  canvas.add(rect);

  selectObj(rect);
  setTool("move");

  saveToLocal();
});

canvas.on("object:modified", e => {
  if(!isEditor) return;
  const o = e.target;
  if(!o || !o.zoneData) return;

  const z = o.zoneData;

  const newW = Math.round(o.getScaledWidth());
  const newH = Math.round(o.getScaledHeight());

  z.x = Math.round(o.left);
  z.y = Math.round(o.top);
  z.w = newW;
  z.h = newH;

  o.set({ scaleX:1, scaleY:1, width:z.w, height:z.h, left:z.x, top:z.y });
  o.setCoords();
VIEWS[currentViewId].zones = zonesData;
  saveToLocal();
});

/* =========================================================
   STABLE LAYOUT EVENTS (UNIFI√âS)
   ========================================================= */
window.addEventListener("resize", () => scheduleRelayout(300));
window.addEventListener("orientationchange", () => scheduleRelayout(450));
if(window.visualViewport){
  window.visualViewport.addEventListener("resize", () => scheduleRelayout(300));
  window.visualViewport.addEventListener("scroll", () => scheduleRelayout(300));
}

function loadView(src){
  const img = $("imgLayer");

  img.onload = () => {
    currentViewId = src;      // ‚úÖ SOURCE UNIQUE
    bootZones();              // ‚úÖ charge les zones de cette vue
    scheduleRelayout(300);    // ‚úÖ recentrage
  };

  img.src = src;              // üî• d√©clenche le onload
}
img.onload = () => {
  currentViewId = img.getAttribute("src");
  $("btnViewMenu").textContent = "üñºÔ∏è";
  bootZones();
  scheduleRelayout(300);
};
const viewMenu = $("viewMenu");
const viewList = $("viewList");
const btnViewMenu = $("btnViewMenu");

btnViewMenu.addEventListener("click", openViewMenu);

function openViewMenu(){
  viewList.innerHTML = "";

  VIEWS_CATALOG.forEach(v=>{
    const b = document.createElement("button");
    b.className = "btn";
    b.textContent = (currentViewId === v.src ? "‚úÖ " : "") + v.label;
    b.onclick = () => {
      closeViewMenu();
      if(v.type === "image") loadView(v.src);
      if(v.type === "video") loadVideoView(v.src);
    };
    viewList.appendChild(b);
  });

  viewMenu.style.display = "flex";
}

function closeViewMenu(){
  viewMenu.style.display = "none";
}


$("btnViewMain").onclick = () => {
  closePiecePanel();
  loadView("actif/compresseur_bg.png");
};

$("btnView1").onclick = () => {
  closePiecePanel();
  loadView("actif/vues/cylindre_lp_face.jpg");
};

$("btnView2").onclick = () => {
  closePiecePanel();
  loadView("actif/vues/cylindre_lp_coupe.jpg");
};



/* =========================================================
   BOOT
   ========================================================= */
tool = "move";
setUI();
loadView("actif/compresseur_bg.png");
</script>
<div id="viewMenu" style="
  position:fixed;
  inset:0;
  background:rgba(5,11,36,.95);
  z-index:25000;
  display:none;
  flex-direction:column;
">
  <div style="padding:14px;font-weight:900;">
    üìÇ Choisir une vue
  </div>
  <div id="viewList" style="overflow:auto;padding:10px;"></div>
  <button class="btn" onclick="closeViewMenu()">‚ùå Fermer</button>
</div>

<!-- MENU DES VUES -->
<div id="viewMenu" style="
  position:fixed;
  inset:0;
  background:#0f1a44;
  z-index:25000;
  display:none;
  flex-direction:column;
">
  <div class="panelHeader">
    <span>üñºÔ∏è Choisir une vue</span>
    <button onclick="closeViewMenu()">‚úï</button>
  </div>

  <div class="panelContent" id="viewList"></div>
</div>

</body>
</html>