<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Q310 ‚Äì √âditeur iPhone</title>

<script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>

<style>
html,body{
  margin:0;
  background:#0b1436;
  color:#eaf1ff;
  font-family:Arial,Segoe UI,sans-serif;
}

/* ==== UI ==== */
#fab{
  position:fixed;
  bottom:10px;
  left:10px;
  width:46px;
  height:46px;
  font-size:22px;
  z-index:10000;
}

#panel{
  position:fixed;
  left:10px;
  bottom:70px;
  width:calc(100vw - 20px);
  max-height:70vh;
  overflow:auto;
  background:#0f1a44;
  padding:10px;
  display:none;
  z-index:10000;
}

.btn{
  width:100%;
  min-height:44px;
  margin-top:8px;
  font-weight:800;
}

#editorBadge{
  position:fixed;
  top:10px;
  left:10px;
  background:#ff9800;
  color:#000;
  padding:6px 10px;
  font-weight:900;
  display:none;
  z-index:10000;
}

/* ==== CANVAS ==== */
.stage{
  position:relative;
  height:100vh;
}

canvas{
  position:absolute;
  inset:0;
}

/* üîë FIX CRITIQUE MENU IPHONE */
.canvas-container{
  pointer-events:none;
}
#fab, #panel{
  pointer-events:auto;
}
</style>
</head>

<body>

<div class="stage">
  <canvas id="c"></canvas>
</div>

<button id="fab">‚ò∞</button>

<div id="panel">
  <div style="font-weight:900;">üß∞ Menu</div>

  <input id="pw" placeholder="Mot de passe (comp)">
  <button id="btnEditor" class="btn">Activer √©diteur</button>
  <button id="btnExit" class="btn" style="display:none;">Quitter √©diteur</button>

  <button id="btnMove" class="btn" disabled>D√©placer</button>
  <button id="btnResize" class="btn" disabled>Redimensionner</button>
  <button id="btnDraw" class="btn" disabled>Nouvelle zone</button>
</div>

<div id="editorBadge">‚úèÔ∏è MODE √âDITEUR</div>

<script>
/* =========================
   CONFIG
========================= */
const EDITOR_PASSWORD = "comp";
const ZONES_JSON = [
  { id:"cylindre_lp", x:420, y:180, w:120, h:260 },
  { id:"filtre_air", x:120, y:220, w:80,  h:200 },
  { id:"manometre_hp", x:520, y:360, w:110, h:110 }
];

/* =========================
   SETUP
========================= */
const $ = id => document.getElementById(id);
let isEditor=false, tool="view", selected=null;
let drawing=false, start=null, tempRect=null;

const canvas = new fabric.Canvas("c",{ selection:false });
canvas.setWidth(window.innerWidth);
canvas.setHeight(window.innerHeight);

/* Touch-friendly */
fabric.Object.prototype.cornerSize = 36;
fabric.Object.prototype.cornerStyle = "circle";
fabric.Object.prototype.transparentCorners = false;
fabric.Object.prototype.targetFindTolerance = 30;

/* =========================
   UI
========================= */
$("fab").onclick = () => {
  $("panel").style.display =
    $("panel").style.display==="block" ? "none":"block";
};

$("btnEditor").onclick = () => {
  if($("pw").value.trim()!==EDITOR_PASSWORD){
    alert("Mot de passe incorrect");
    return;
  }
  isEditor=true;
  tool="move";
  updateUI();
};

$("btnExit").onclick = () => {
  isEditor=false;
  tool="view";
  clearSelection();
  updateUI();
};

$("btnMove").onclick = ()=>{ tool="move"; applyMode(); };
$("btnResize").onclick = ()=>{ tool="resize"; applyMode(); };
$("btnDraw").onclick = ()=>{ tool="draw"; applyMode(); };

function updateUI(){
  $("editorBadge").style.display = isEditor?"block":"none";
  $("btnEditor").style.display = isEditor?"none":"block";
  $("btnExit").style.display   = isEditor?"block":"none";
  $("btnMove").disabled   = !isEditor;
  $("btnResize").disabled = !isEditor;
  $("btnDraw").disabled   = !isEditor;
  applyMode();
}

/* =========================
   MODES
========================= */
function applyMode(){
  canvas.forEachObject(o=>{
    o.selectable = isEditor && tool!=="draw";
    o.hasControls = isEditor && tool==="resize";
    o.hasBorders = isEditor;
    o.stroke = (o===selected && isEditor)?"orange":"white";
    o.strokeWidth = 3;
    o.lockRotation = true;
  });
  canvas.requestRenderAll();
}

/* =========================
   SELECTION
========================= */
function selectObj(obj){
  if(selected && selected!==obj){
    selected.stroke="white";
  }
  selected=obj;
  obj.stroke="orange";
  canvas.setActiveObject(obj);
  canvas.requestRenderAll();
}

function clearSelection(){
  if(selected){
    selected.stroke="white";
    selected=null;
    canvas.discardActiveObject();
    canvas.requestRenderAll();
  }
}

/* =========================
   EVENTS
========================= */
canvas.on("mouse:down",opt=>{
  const obj=opt.target;

  if(isEditor && tool==="draw"){
    drawing=true;
    start=canvas.getPointer(opt.e);
    tempRect=new fabric.Rect({
      left:start.x, top:start.y,
      width:2, height:2,
      fill:"rgba(255,255,255,0.08)",
      stroke:"#00a2ff", strokeWidth:3,
      selectable:false, evented:false
    });
    canvas.add(tempRect);
    return;
  }

  if(obj) selectObj(obj);
  else clearSelection();
});

canvas.on("mouse:move",opt=>{
  if(!(drawing && tempRect)) return;
  const p=canvas.getPointer(opt.e);
  tempRect.set({
    left:Math.min(start.x,p.x),
    top:Math.min(start.y,p.y),
    width:Math.abs(p.x-start.x),
    height:Math.abs(p.y-start.y)
  });
  canvas.requestRenderAll();
});

canvas.on("mouse:up",()=>{
  if(!(drawing && tempRect)) return;
  drawing=false;
  const r=tempRect;
  canvas.remove(tempRect);
  tempRect=null;

  if(r.width<12||r.height<12) return;

  const zone=new fabric.Rect({
    left:r.left, top:r.top,
    width:r.width, height:r.height,
    fill:"rgba(255,255,255,0.08)",
    stroke:"white", strokeWidth:3
  });
  zone.zoneId="nouvelle_zone";
  canvas.add(zone);
  applyMode();
});

/* =========================
   LOAD ZONES
========================= */
ZONES_JSON.forEach(z=>{
  const r=new fabric.Rect({
    left:z.x, top:z.y,
    width:z.w, height:z.h,
    fill:"rgba(255,255,255,0.08)",
    stroke:"white", strokeWidth:3
  });
  r.zoneId=z.id;
  canvas.add(r);
});

updateUI();
</script>
</body>
</html>