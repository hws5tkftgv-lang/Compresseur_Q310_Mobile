<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Q310 ‚Äì iPhone √âditeur</title>

<script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>

<style>
html, body{
  margin:0;
  height:100%;
  overflow:hidden;
  background:#0b1436;
  color:#eaf1ff;
  font-family:Arial,Segoe UI,sans-serif;
}
#infoPanel{padding:10px;background:#0f1a44;border-bottom:1px solid rgba(255,255,255,.15);}
#infoTitle{font-size:18px;font-weight:800;}

.stage{position:relative;height:calc(100dvh - 120px);overflow:hidden;background:#0b1536;}
.media-layer,canvas{position:absolute;inset:0;}
#imgLayer{width:100%;height:100%;object-fit:contain;pointer-events:none;}

.stage,.canvas-container,canvas{touch-action:none !important;}

#fab{
  position:fixed;bottom:10px;left:10px;width:46px;height:46px;border-radius:10px;
  background:#ffffff22;border:1px solid #ffffff55;color:#fff;font-size:22px;z-index:9999;
}

#panel{
  position:fixed;
  left:10px;
  bottom:70px;
  width:calc(100vw - 20px);
  max-height:65vh;
  overflow-y:auto;
  overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
  background:#0f1a44;
  border:1px solid rgba(255,255,255,.2);
  padding:10px;
  border-radius:12px;
  display:none;
  z-index:10000;
}

.sectionTitle{
  margin-top:12px;
  font-size:12px;
  opacity:.7;
  font-weight:700;
  text-transform:uppercase;
}
.btn{
  width:100%;min-height:44px;margin-top:8px;background:#1b2553;color:#fff;
  border:1px solid rgba(255,255,255,.2);border-radius:10px;font-size:15px;font-weight:800;
}
.btn.active{background:#ff9800;color:#000;}

.input{
  width:100%;min-height:44px;margin-top:8px;background:#101a40;color:#fff;
  border:1px solid rgba(255,255,255,.2);border-radius:10px;font-size:15px;
  padding:10px;box-sizing:border-box;
}

.small{font-size:12px;opacity:.85;line-height:1.35;margin-top:8px;}


</style>
</head>

<body>

<!-- ===== Bande info √©l√®ve ===== -->
<div id="infoPanel">
  <div id="infoTitle">S√©lectionne une zone</div>
  <div id="infoText" style="font-size:14px; opacity:.9; margin-top:4px;"></div>
</div>

<!-- ===== Zone image + canvas ===== -->
<div class="stage" id="stage">
  <div class="media-layer">
    <img id="imgLayer" src="actif/compresseur_bg.png" alt="">
  </div>
  <canvas id="c"></canvas>
</div>

<!-- ===== Bouton menu flottant ===== -->
<button id="fab">‚ò∞</button>

<!-- ===== MENU UNIQUE ===== -->
<div id="panel">

  <div style="font-weight:900;margin-bottom:6px;">üß∞ Menu</div>

  <!-- √âtat -->
  <div id="stateLine" style="font-weight:900;opacity:.9;">MODE √âL√àVE</div>

  <!-- Connexion √©diteur -->
  <input id="pw" class="input" type="password" placeholder="Mot de passe √©diteur (comp)">
  <button id="btnEditor" class="btn">üîí Activer √©diteur</button>
  <button id="btnExit" class="btn" style="display:none;">üö™ Quitter √©diteur</button>

  <!-- ===== OUTILS ===== -->
  <div class="sectionTitle">Outils</div>
  <button id="btnMove" class="btn" disabled>‚úã D√©placer</button>
  <button id="btnResize" class="btn" disabled>‚¨ç Redimensionner</button>
  <button id="btnDraw" class="btn" disabled>‚ûï Nouvelle zone</button>

  <!-- ===== √âDITION ZONE ===== -->
  <div class="sectionTitle">Zone s√©lectionn√©e</div>
  <input id="editNom" class="input" placeholder="Nom">
  <textarea id="editRole" class="input" placeholder="R√¥le"></textarea>
  <textarea id="editDesc" class="input" placeholder="Description"></textarea>

  <button id="btnApply" class="btn">üíæ Appliquer</button>
  <button id="btnDelete" class="btn">üóëÔ∏è Supprimer la zone</button>

  <!-- ===== SAUVEGARDE ===== -->
  <div class="sectionTitle">Sauvegarde</div>
  <button id="btnExport" class="btn">üì§ Export JSON</button>

</div>

<!-- ===== Badge √©diteur ===== -->
<div id="editorState"
     style="position:fixed;top:10px;left:10px;
            background:#ff9800;color:#000;
            padding:6px 10px;border-radius:8px;
            font-weight:900;z-index:9999;
            display:none;">
  ‚úèÔ∏è MODE √âDITEUR
</div>

<script>
let zonesData = [];
const EDITOR_PASSWORD = "comp";
const PARTS = {
  filtre_air: {
    nom: "Filtre √† air",
    role: "Filtrer l‚Äôair entrant",
    desc: "Retient les poussi√®res et impuret√©s avant l‚Äôadmission."
  },
  cylindre_lp: {
    nom: "Cylindre basse pression (LP)",
    role: "Compression initiale",
    desc: "Premi√®re √©tape de compression volum√©trique."
  },
  manometre_hp: {
    nom: "Manom√®tre HP",
    role: "Indiquer la pression",
    desc: "Lecture de la pression de service en sortie."
  }
};
const $ = id => document.getElementById(id);

let isEditor = false;
let tool = "view"; // view | move | resize | draw
let selected = null;

let drawing = false;
let start = null;
let tempRect = null;

/* ‚úÖ ZONES : UNE SEULE D√âCLARATION (IMPORTANT) */


const canvas = new fabric.Canvas("c", { selection:false });


canvas.selection = false;
canvas.preserveObjectStacking = true;
imgLayer.onload = fitCanvasToImage;
window.addEventListener("resize", fitCanvasToImage);
canvas.on("object:modified", () => {
  if (!isEditor) return;

  if (!selected) return;

  // üîó retrouver la zone li√©e au rectangle
  const zone = ZONES.find(z => z._obj === selected);
  if (!zone) return;

  // üîÑ mise √† jour des dimensions
  zone.x = Math.round(selected.left);
  zone.y = Math.round(selected.top);
  zone.w = Math.round(selected.width * selected.scaleX);
  zone.h = Math.round(selected.height * selected.scaleY);

  // üîß reset scale pour √©viter l‚Äôaccumulation
  selected.set({
    scaleX: 1,
    scaleY: 1,
    width: zone.w,
    height: zone.h,
    left: zone.x,
    top: zone.y
  });

  selected.setCoords();

  console.log("Zone mise √† jour :", zone);
});

/* ‚úÖ iPhone / iOS : emp√™che Safari d'intercepter les gestes */
canvas.upperCanvasEl.style.touchAction = "none";
canvas.upperCanvasEl.style.webkitUserSelect = "none";
canvas.upperCanvasEl.style.webkitTouchCallout = "none";

/* ‚úÖ ergonomie tactile */
fabric.Object.prototype.cornerSize = 36;
fabric.Object.prototype.cornerStyle = "circle";
fabric.Object.prototype.transparentCorners = false;
fabric.Object.prototype.padding = 10;

/* ‚úÖ s√©lection plus facile sur iPhone */
fabric.Object.prototype.perPixelTargetFind = false;
fabric.Object.prototype.targetFindTolerance = 40;

$("btnApply").onclick = () => {
  if (!isEditor || !selected || !selected.zoneData) return;

  // 1Ô∏è‚É£ √©crire dans la donn√©e logique
  selected.zoneData.nom  = $("editNom").value.trim();
  selected.zoneData.role = $("editRole").value.trim();
  selected.zoneData.desc = $("editDesc").value.trim();

  // 2Ô∏è‚É£ mise √† jour imm√©diate du panneau √©l√®ve
  $("infoTitle").textContent =
    selected.zoneData.nom || "Zone";

  $("infoText").textContent =
    (selected.zoneData.role || "") +
    (selected.zoneData.desc
      ? " ‚Äî " + selected.zoneData.desc
      : "");
};
$("btnDelete").onclick = () => {
  if(!isEditor || !selected) return;

  // 1. Retirer du tableau JSON
  const i = zonesData.indexOf(selected.zoneData);
  if(i !== -1) zonesData.splice(i, 1);

  // 2. Retirer du canvas
  canvas.remove(selected);

  // 3. Nettoyer la s√©lection
  selected = null;
  canvas.discardActiveObject();
  canvas.requestRenderAll();

  // 4. R√©initialiser l‚Äôaffichage √©l√®ve
  $("infoTitle").textContent = "S√©lectionne une zone";
  $("infoText").textContent = "";
};
$("btnExport").onclick = ()=>{
  const data = [];

  canvas.getObjects().forEach(o=>{
    if(!o.zoneId) return;

    data.push({
      id: o.zoneId,
      x: Math.round(o.left),
      y: Math.round(o.top),
      w: Math.round(o.width * o.scaleX),
      h: Math.round(o.height * o.scaleY)
    });
  });

  const json = JSON.stringify(data, null, 2);
  prompt("Copie-colle ce JSON :", json);
};
function resize(){
  canvas.setWidth($("stage").clientWidth);
  canvas.setHeight($("stage").clientHeight);
  canvas.calcOffset();
}
window.addEventListener("resize", resize);
resize();

/* ===== UI ===== */
function setUI(){
  $("editorState").style.display = isEditor ? "block" : "none";
  $("stateLine").textContent = isEditor ? "MODE √âDITEUR" : "MODE √âL√àVE";

  $("btnEditor").style.display = isEditor ? "none" : "block";
  $("btnExit").style.display   = isEditor ? "block" : "none";

  $("btnMove").disabled   = !isEditor;
  $("btnResize").disabled = !isEditor;
  $("btnDraw").disabled   = !isEditor;

  applyMode();
}

function showAllResizeHandles(obj, on){
  obj.setControlsVisibility({
    tl:on, tr:on, bl:on, br:on,
    ml:on, mt:on, mr:on, mb:on,
    mtr:false
  });
}

function applyMode(){

  canvas.forEachObject(o=>{

    /* ===== PAR D√âFAUT : MODE √âL√àVE ===== */
    o.evented = false;
    o.selectable = false;
    o.hasControls = false;
    o.hasBorders = false;

    o.lockMovementX = true;
    o.lockMovementY = true;
    o.lockScalingX  = true;
    o.lockScalingY  = true;
    o.lockRotation = true;

    showAllResizeHandles(o,false);

    /* ===== MODE √âDITEUR ===== */
    if(isEditor){

      o.evented = true;
      o.lockRotation = true;

      if(tool === "draw"){
        o.selectable = false;
        o.evented = false;   // IMPORTANT
      }

      else if(tool === "move"){
        o.selectable = true;
        o.hasBorders = true;

        o.lockMovementX = false;
        o.lockMovementY = false;

        showAllResizeHandles(o,false);
      }

      else if(tool === "resize"){
        o.selectable = true;
        o.hasBorders = true;
        o.hasControls = true;

        o.lockMovementX = false;
        o.lockMovementY = false;
        o.lockScalingX  = false;
        o.lockScalingY  = false;

        showAllResizeHandles(o,true);
      }
    }

  });

  canvas.requestRenderAll();
}
function togglePanel(){
  const p = $("panel");
  p.style.display = (p.style.display === "block") ? "none" : "block";
}

// iOS: click + touchend, avec stopPropagation pour √©viter Fabric
["click","touchend"].forEach(evt=>{
  $("fab").addEventListener(evt, (e)=>{
    e.preventDefault();
    e.stopPropagation();
    togglePanel();
  }, { passive:false });
});
/* ===== Editor ON/OFF ===== */
$("btnEditor").onclick = ()=>{
  const p = ($("pw").value || "").trim();
  if(p !== EDITOR_PASSWORD){
    alert("Mot de passe incorrect.");
    return;
  }
  isEditor = true;
  tool = "move";
  setUI();
};
$("btnExit").onclick = ()=>{
  isEditor = false;
  tool = "view";
  clearSelection();
  setUI();
};

/* ===== Tools ===== */
$("btnMove").onclick = ()=>{ if(!isEditor) return; tool="move"; applyMode(); };
$("btnResize").onclick = ()=>{ if(!isEditor) return; tool="resize"; applyMode(); };
$("btnDraw").onclick = ()=>{ if(!isEditor) return; tool="draw"; clearSelection(); applyMode(); };

/* ===== Selection ===== */
function selectObj(obj){
  if(!obj || !obj.zoneData) return;
  if(!obj) return;

  if(selected && selected !== obj){
    selected.set({ stroke:"white", strokeWidth:3 });
    showAllResizeHandles(selected,false);
  }

  selected = obj;
  canvas.setActiveObject(obj);

  // highlight
  obj.set({ stroke:"orange", strokeWidth:5 });

  if(isEditor && tool === "resize"){
    showAllResizeHandles(obj,true);
    obj.hasControls = true;
  }else{
    showAllResizeHandles(obj,false);
    obj.hasControls = false;
  }
  if(isEditor && obj.zoneId){
  const part = PARTS[obj.zoneId] || {};
$("infoTitle").textContent = obj.zoneData.nom || obj.zoneData.id;
$("infoRole").textContent  = obj.zoneData.role || "";
$("infoDesc").textContent  = obj.zoneData.desc || "";
}

  // info (au lieu de alert qui ‚Äúg√®le‚Äù)
  //$("infoTitle").textContent = "Zone : " + (obj.zoneId || "(sans id)");
$("infoTitle").textContent =
  obj.zoneData?.nom || "Zone";
  
  canvas.requestRenderAll();
}

function clearSelection(){
  if(!selected) return;
  selected.set({ stroke:"white", strokeWidth:3 });
  showAllResizeHandles(selected,false);
  selected = null;
  canvas.discardActiveObject();
  canvas.requestRenderAll();
}

/* ===== Draw + Tap handling : UN SEUL HANDLER (IMPORTANT) ===== */
canvas.on("mouse:down", opt => {
  
  // ‚úÖ EN MODE MOVE : laisser Fabric g√©rer le drag
  if(isEditor && tool === "move"){
    return;
  }
const obj = opt.target;
  if(isEditor && tool === "draw"){
    drawing = true;
    start = canvas.getPointer(opt.e);

    tempRect = new fabric.Rect({
      left: start.x,
      top: start.y,
      width: 2,
      height: 2,
      fill: "rgba(255,255,255,0.10)",
      stroke: "#00a2ff",
      strokeWidth: 3,
      selectable: false,
      evented: false
    });

    canvas.add(tempRect);
    canvas.requestRenderAll();
    return;
  }

  if(obj){
    selectObj(obj);

    if(obj.zoneId && PARTS[obj.zoneId]){
      $("infoTitle").textContent = PARTS[obj.zoneId].nom;
$("infoText").textContent =
  PARTS[obj.zoneId].role + " ‚Äî " + PARTS[obj.zoneId].desc;
    }
  }else{
  clearSelection();
  $("infoTitle").textContent = "S√©lectionne une zone";
  $("infoText").textContent = "";
}
});

canvas.on("mouse:move", opt=>{
  if(!(drawing && tempRect)) return;
  const p = canvas.getPointer(opt.e);

  const left = Math.min(start.x, p.x);
  const top  = Math.min(start.y, p.y);
  const w = Math.abs(p.x - start.x);
  const h = Math.abs(p.y - start.y);

  tempRect.set({ left, top, width:Math.max(2,w), height:Math.max(2,h) });
  tempRect.setCoords();
  canvas.requestRenderAll();
});

canvas.on("mouse:up", ()=>{
  if(!(drawing && tempRect)) return;
  drawing = false;

  const r = tempRect;
  canvas.remove(tempRect);
  tempRect = null;

  if(r.width < 12 || r.height < 12) return;

  // üîπ Infos p√©dagogiques
  const nom  = prompt("Nom de la zone ?");
  if(!nom) return;

  const role = prompt("R√¥le de la zone ?");
  const desc = prompt("Description de la zone ?");

  const ok = confirm("Sauvegarder cette zone ?");
  if(!ok) return;

  const id = "zone_" + Date.now();

  const zoneData = { id, nom, role, desc };

  const zone = new fabric.Rect({
    left: r.left,
    top: r.top,
    width: r.width,
    height: r.height,
    fill: "rgba(255,255,255,0.08)",
    stroke: "white",
    strokeWidth: 3,
    lockRotation: true
  });

  zone.zoneId = id;
  zone.zoneData = zoneData;

  zonesData.push(zoneData);
  canvas.add(zone);
  canvas.setActiveObject(zone);

  selectObj(zone);
});

// üîó lien bidirectionnel (INDISPENSABLE)
zone.zoneId = newId;
zone.zoneData = zoneData;
zoneData._obj = zone;

// üì¶ stockage
zonesData.push(zoneData);
canvas.add(zone);

// üéØ s√©lection imm√©diate
applyMode();
selectObj(zone);
setUI();
});
function exportZonesJSON(){
  const zones = [];

  canvas.getObjects().forEach(o=>{
    if(!o.zoneId) return;

    zones.push({
      id: o.zoneId,
      x: Math.round(o.left),
      y: Math.round(o.top),
      w: Math.round(o.width * o.scaleX),
      h: Math.round(o.height * o.scaleY)
    });
  });

  const json = JSON.stringify(zones, null, 2);

  // t√©l√©chargement iPhone / Safari
  const blob = new Blob([json], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "zones_mobile.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function fitCanvasToImage(){
  const img   = document.getElementById("imgLayer");
  const stage = document.getElementById("stage");

  if(!img.naturalWidth) return; // image pas encore charg√©e

  const stageW = stage.clientWidth;
  const stageH = stage.clientHeight;

  const imgRatio   = img.naturalWidth / img.naturalHeight;
  const stageRatio = stageW / stageH;

  let canvasW, canvasH, offsetX = 0, offsetY = 0;

  if(stageRatio > imgRatio){
    canvasH = stageH;
    canvasW = canvasH * imgRatio;
    offsetX = (stageW - canvasW) / 2;
  }else{
    canvasW = stageW;
    canvasH = canvasW / imgRatio;
    offsetY = (stageH - canvasH) / 2;
  }

  canvas.setWidth(canvasW);
  canvas.setHeight(canvasH);
  canvas.calcOffset();

  canvas.getElement().style.left = offsetX + "px";
  canvas.getElement().style.top  = offsetY + "px";

  canvas.requestRenderAll();
}
// ===== EXPORT JSON (iOS SAFE) =====
$("btnExport").addEventListener("click", exportZonesJSON, { passive:false });
$("btnExport").addEventListener("touchend", (e)=>{
  e.preventDefault();
  exportZonesJSON();
}, { passive:false });

function exportZonesJSON(){
  const data = [];

  canvas.getObjects().forEach(o=>{
    if(!o.zoneId) return;

    data.push({
      id: o.zoneId,
      x: Math.round(o.left),
      y: Math.round(o.top),
      w: Math.round(o.width * o.scaleX),
      h: Math.round(o.height * o.scaleY),
      nom: o.zoneData?.nom || "",
      role: o.zoneData?.role || "",
      desc: o.zoneData?.desc || ""
    });
  });

  const json = JSON.stringify(data, null, 2);

  // ‚úÖ T√©l√©chargement iPhone / Safari fiable
  const blob = new Blob([json], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "zones_mobile.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  URL.revokeObjectURL(url);
}
</script>

</body>
</html>