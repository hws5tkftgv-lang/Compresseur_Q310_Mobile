<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Q310 ‚Äì iPhone √âditeur</title>

<script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
<script>
  alert("fabric = " + typeof fabric);
</script>
<style>
html,body{margin:0;background:#0b1436;color:#eaf1ff;font-family:Arial,Segoe UI,sans-serif;}
#infoPanel{padding:10px;background:#0f1a44;border-bottom:1px solid rgba(255,255,255,.15);}
#infoTitle{font-size:18px;font-weight:800;}

.stage{position:relative;height:calc(100dvh - 120px);overflow:hidden;background:#0b1536;}
.media-layer,canvas{position:absolute;inset:0;}
#imgLayer{width:100%;height:100%;object-fit:contain;pointer-events:none;}

.stage,.canvas-container,canvas{touch-action:none !important;}

#fab{
  position:fixed;bottom:10px;left:10px;width:46px;height:46px;border-radius:10px;
  background:#ffffff22;border:1px solid #ffffff55;color:#fff;font-size:22px;z-index:9999;
}

#panel{
  position:fixed;left:10px;bottom:70px;width:calc(100vw - 20px);
  max-height:70dvh;overflow:auto;background:#0f1a44;border:1px solid rgba(255,255,255,.2);
  display:none;z-index:9999;padding:10px;border-radius:12px;
}

.btn{
  width:100%;min-height:44px;margin-top:8px;background:#1b2553;color:#fff;
  border:1px solid rgba(255,255,255,.2);border-radius:10px;font-size:15px;font-weight:800;
}
.btn.active{background:#ff9800;color:#000;}

.input{
  width:100%;min-height:44px;margin-top:8px;background:#101a40;color:#fff;
  border:1px solid rgba(255,255,255,.2);border-radius:10px;font-size:15px;
  padding:10px;box-sizing:border-box;
}

#editorState{
  position:fixed;top:10px;right:10px;background:#ff9800;color:#000;padding:6px 10px;
  font-weight:900;border-radius:8px;display:none;z-index:9999;
}

.small{font-size:12px;opacity:.85;line-height:1.35;margin-top:8px;}
</style>
</head>

<body>
<div id="infoPanel"><div id="infoTitle">S√©lectionne une zone</div></div>

<div class="stage" id="stage">
  <div class="media-layer"><img id="imgLayer" src="actif/compresseur_bg.png" alt=""></div>
  <canvas id="c"></canvas>
</div>

<button id="fab">‚ò∞</button>

<div id="panel">
  <div style="font-weight:900;margin-bottom:6px;">üß∞ Menu</div>

  <div id="stateLine" style="font-weight:900;opacity:.9;">MODE √âL√àVE</div>

  <input id="pw" class="input" type="password" placeholder="Mot de passe √©diteur (comp)">
  <button id="btnEditor" class="btn">üîí Activer √©diteur</button>
  <button id="btnExit" class="btn" style="display:none;">üö™ Quitter √©diteur</button>

  <div class="small">Outils (actifs seulement en mode √©diteur)</div>
  <button id="btnMove" class="btn" disabled>‚úã D√©placer</button>
  <button id="btnResize" class="btn" disabled>‚¨ç Redimensionner</button>
  <button id="btnDraw" class="btn" disabled>‚ûï Nouvelle zone</button>
</div>

<div id="editorState"
     style="position:fixed;top:10px;left:10px;
            background:#ff9800;color:#000;
            padding:6px 10px;border-radius:8px;
            font-weight:900;z-index:9999;
            display:none;">
  ‚úèÔ∏è MODE √âDITEUR
</div>

<script>
const EDITOR_PASSWORD = "comp";
const $ = id => document.getElementById(id);
const ZONES = [
  { id: "cylindre_lp", x: 420, y: 180, w: 120, h: 260 },
  { id: "filtre_air", x: 120, y: 220, w: 80,  h: 200 },
  { id: "manometre_hp", x: 520, y: 360, w: 110, h: 110 }
];

let isEditor = false;
let tool = "view";
let selected = null;
let drawing = false, start = null, tempRect = null;

const canvas = new fabric.Canvas("c", { selection:false });
// üîë iPhone : d√©tection tactile beaucoup plus permissive
fabric.Object.prototype.cornerSize = 36;
fabric.Object.prototype.cornerStyle = "circle";
fabric.Object.prototype.transparentCorners = false;
fabric.Object.prototype.padding = 10;
fabric.Object.prototype.perPixelTargetFind = false;
fabric.Object.prototype.targetFindTolerance = 30;

function resize(){
  canvas.setWidth($("stage").clientWidth);
  canvas.setHeight($("stage").clientHeight);
  canvas.calcOffset();
}
window.addEventListener("resize", resize);
resize();

function setUI(){
  $("editorState").style.display = isEditor ? "block" : "none";
  $("stateLine").textContent = isEditor ? "MODE √âDITEUR" : "MODE √âL√àVE";

  $("btnEditor").style.display = isEditor ? "none" : "block";
  $("btnExit").style.display   = isEditor ? "block" : "none";

  $("btnMove").disabled   = !isEditor;
  $("btnResize").disabled = !isEditor;
  $("btnDraw").disabled   = !isEditor;

  applyMode();
}
function showAllResizeHandles(obj, on){
  obj.setControlsVisibility({
    tl:on, tr:on, bl:on, br:on,
    ml:on, mt:on, mr:on, mb:on,
    mtr:false
  });
}

function applyMode(){
  canvas.forEachObject(o=>{
    o.evented = true;

    if(!isEditor){
      // MODE √âL√àVE
      o.selectable = false;
      o.hasControls = false;
      o.hasBorders = false;
      o.stroke = "white";
      o.strokeWidth = 3;

      o.lockMovementX = true;
      o.lockMovementY = true;
      o.lockScalingX = true;
      o.lockScalingY = true;
    }
    else{
      // MODE √âDITEUR (BASE COMMUNE)
      o.stroke = "orange";
      o.strokeWidth = 3;

      // üîë D√âVERROUILLAGE TOTAL
      o.lockMovementX = false;
      o.lockMovementY = false;
      o.lockScalingX = false;
      o.lockScalingY = false;
      o.lockRotation = true;

      if(tool === "draw"){
        o.selectable = false;
        o.hasControls = false;
        o.hasBorders = true;
      }
      else if(tool === "move"){
        o.selectable = true;
        o.hasControls = false;
        o.hasBorders = true;
      }
      else if(tool === "resize"){
        o.selectable = true;
        o.hasControls = true;
        o.hasBorders = true;

        // poign√©es coins + c√¥t√©s
        o.setControlsVisibility({
          tl:true, tr:true, bl:true, br:true,
          ml:true, mt:true, mr:true, mb:true,
          mtr:false
        });
      }
    }
  });

  canvas.requestRenderAll();
}

/* Menu open/close */
$("fab").onclick = ()=> {
  $("panel").style.display = ($("panel").style.display==="block") ? "none" : "block";
};

/* Editor ON (no prompt) */
$("btnEditor").onclick = ()=>{
  const p = ($("pw").value || "").trim();
  if(p !== EDITOR_PASSWORD){
    alert("Mot de passe incorrect.");
    return;
  }
  isEditor = true;
  tool = "move";
  setUI();
  // üëá AJOUTE CES 2 LIGNES
$("editorState").style.display = "block";
$("editorState").textContent = "‚úèÔ∏è MODE √âDITEUR";
};

/* Editor OFF */
$("btnExit").onclick = ()=>{
  isEditor = false;
  tool = "view";
  setUI();
  

// üëá AJOUTE CES 2 LIGNES
$("editorState").style.display = "none";
};

/* Tools */
$("btnMove").onclick = ()=>{ tool="move"; applyMode(); };
$("btnResize").onclick = ()=>{ tool="resize"; applyMode(); };
$("btnDraw").onclick = ()=>{ tool="draw"; applyMode(); };

function selectObj(obj){
  if(!obj) return;

  // D√©s√©lection pr√©c√©dente
  if(selected && selected !== obj){
    showAllResizeHandles(selected, false);
    selected.set({
      stroke: "rgba(255,255,255,0.85)",
      strokeWidth: 3
    });
  }

  selected = obj;

  obj.set({
    stroke: "orange",
    strokeWidth: 5,
    selectable: true,
    hasControls: true,
    hasBorders: true
  });

  // üîë 8 poign√©es (coins + c√¥t√©s)
  showAllResizeHandles(obj, true);

  canvas.setActiveObject(obj);
  canvas.requestRenderAll();
}
function clearSelection(){
  if(!selected) return;

  showAllResizeHandles(selected, false);

  selected.set({
    stroke: "rgba(255,255,255,0.85)",
    strokeWidth: 3
  });

  selected = null;
  canvas.discardActiveObject();
  canvas.requestRenderAll();
}
canvas.on("mouse:down", opt => {
  const obj = opt.target;

  if(tool === "draw" && isEditor){
    drawing = true;
    start = canvas.getPointer(opt.e);

    tempRect = new fabric.Rect({
      left: start.x,
      top: start.y,
      width: 2,
      height: 2,
      fill: "rgba(255,255,255,0.1)",
      stroke: "#00a2ff",
      strokeWidth: 3,
      selectable: false,
      evented: false
    });

    canvas.add(tempRect);
    return;
  }

  if(obj){
    selectObj(obj);
  }else{
    clearSelection();
  }
});
canvas.on("mouse:move", opt=>{
  if(!(drawing && tempRect)) return;
  const p = canvas.getPointer(opt.e);
  const left = Math.min(start.x, p.x);
  const top  = Math.min(start.y, p.y);
  const w = Math.abs(p.x - start.x);
  const h = Math.abs(p.y - start.y);
  tempRect.set({ left, top, width:Math.max(2,w), height:Math.max(2,h) });
  canvas.requestRenderAll();
});

canvas.on("mouse:up", ()=>{
  if(!(drawing && tempRect)) return;
  drawing = false;
  // convert tempRect into real editable zone
  const r = tempRect;
  canvas.remove(tempRect);
  tempRect = null;

  if(r.width < 12 || r.height < 12){
    canvas.requestRenderAll();
    return;
  }

  const zone = new fabric.Rect({
  left: r.left,
  top: r.top,
  width: r.width,
  height: r.height,
  fill: "rgba(255,255,255,0.08)", // üîë HITBOX TACTILE
  stroke: "orange",
  strokeWidth: 4
});
  canvas.add(zone);
  applyMode();
});

const ZONES = [
  { id: "cylindre_lp", x: 420, y: 180, w: 120, h: 260 },
  { id: "filtre_air", x: 120, y: 220, w: 80,  h: 200 },
  { id: "manometre_hp", x: 520, y: 360, w: 110, h: 110 }
];

ZONES.forEach(z => {
  const rect = new fabric.Rect({
    left: z.x,
    top: z.y,
    width: z.w,
    height: z.h,
    fill: "rgba(255,255,255,0.08)", // hitbox tactile
    stroke: "white",
    strokeWidth: 3,
    selectable: false,
    hasControls: false,
    hasBorders: false
  });

  // üîó LIAISON ZONE ‚Üî JSON M√âTIER
  rect.zoneId = z.id;

  canvas.add(rect);
});
setUI();
canvas.on("mouse:down", opt => {
  const obj = opt.target;
  if (!obj) return;
  alert("Zone cliqu√©e : " + obj.zoneId);
});
</script>
<div id="editorState"
     style="
       position:fixed;
       top:10px;
       left:10px;
       background:#ff9800;
       color:#000;
       padding:6px 10px;
       border-radius:8px;
       font-weight:900;
       z-index:9999;
       display:none;">
  ‚úèÔ∏è MODE √âDITEUR
</div>
</body>
</html>