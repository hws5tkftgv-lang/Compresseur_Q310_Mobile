<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Q310 ‚Äì iPhone √âditeur</title>

<script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>

<style>
html,body{margin:0;background:#0b1436;color:#eaf1ff;font-family:Arial,Segoe UI,sans-serif;}
#infoPanel{padding:10px;background:#0f1a44;border-bottom:1px solid rgba(255,255,255,.15);}
#infoTitle{font-size:18px;font-weight:800;}

.stage{position:relative;height:calc(100dvh - 120px);overflow:hidden;background:#0b1536;}
.media-layer,canvas{position:absolute;inset:0;}
#imgLayer{width:100%;height:100%;object-fit:contain;pointer-events:none;}

.canvas-container canvas{
  touch-action:none !important;
}

/* üîë FIX MENU iOS */
.canvas-container{ pointer-events:none; }
#fab, #panel{ pointer-events:auto; }

#fab{
  position:fixed;bottom:10px;left:10px;width:46px;height:46px;border-radius:10px;
  background:#ffffff22;border:1px solid #ffffff55;color:#fff;font-size:22px;z-index:9999;
}

#panel{
  position:fixed;left:10px;bottom:70px;width:calc(100vw - 20px);
  max-height:70dvh;overflow:auto;background:#0f1a44;border:1px solid rgba(255,255,255,.2);
  display:none;z-index:9999;padding:10px;border-radius:12px;
}

.btn{
  width:100%;min-height:44px;margin-top:8px;background:#1b2553;color:#fff;
  border:1px solid rgba(255,255,255,.2);border-radius:10px;font-size:15px;font-weight:800;
}
.btn.active{background:#ff9800;color:#000;}

.input{
  width:100%;min-height:44px;margin-top:8px;background:#101a40;color:#fff;
  border:1px solid rgba(255,255,255,.2);border-radius:10px;font-size:15px;
  padding:10px;box-sizing:border-box;
}

#editorState{
  position:fixed;top:10px;left:10px;background:#ff9800;color:#000;
  padding:6px 10px;font-weight:900;border-radius:8px;display:none;z-index:9999;
}
.small{font-size:12px;opacity:.85;line-height:1.35;margin-top:8px;}
</style>
</head>

<body>

<div id="infoPanel"><div id="infoTitle">S√©lectionne une zone</div></div>

<div class="stage" id="stage">
  <div class="media-layer">
    <img id="imgLayer" src="actif/compresseur_bg.png">
  </div>
  <canvas id="c"></canvas>
</div>

<button id="fab">‚ò∞</button>

<div id="panel">
  <div style="font-weight:900;margin-bottom:6px;">üß∞ Menu</div>

  <div id="stateLine" style="font-weight:900;">MODE √âL√àVE</div>

  <input id="pw" class="input" placeholder="Mot de passe √©diteur (comp)">
  <button id="btnEditor" class="btn">üîí Activer √©diteur</button>
  <button id="btnExit" class="btn" style="display:none;">üö™ Quitter √©diteur</button>

  <div class="small">Outils</div>
  <button id="btnMove" class="btn" disabled>‚úã D√©placer</button>
  <button id="btnResize" class="btn" disabled>‚¨ç Redimensionner</button>
  <button id="btnDraw" class="btn" disabled>‚ûï Nouvelle zone</button>
</div>

<div id="editorState">‚úèÔ∏è MODE √âDITEUR</div>

<script>
let partsMap = new Map();
const EDITOR_PASSWORD="comp";
const $=id=>document.getElementById(id);
const PARTS = [
  {
    id: "filtre_air",
    nom: "Filtre √† air",
    role: "Filtrer l‚Äôair entrant",
    desc: "Retient les poussi√®res et impuret√©s avant l‚Äôadmission."
  },
  {
    id: "cylindre_lp",
    nom: "Cylindre basse pression (LP)",
    role: "Compression initiale",
    desc: "Premi√®re √©tape de compression volum√©trique."
  },
  {
    id: "manometre_hp",
    nom: "Manom√®tre HP",
    role: "Indiquer la pression",
    desc: "Lecture de la pression de service en sortie."
  }
];

const ZONES=[
  {id:"cylindre_lp",x:420,y:180,w:120,h:260},
  {id:"filtre_air",x:120,y:220,w:80,h:200},
  {id:"manometre_hp",x:520,y:360,w:110,h:110}
];

const partsMap = new Map();
PARTS.forEach(p => partsMap.set(p.id, p));
let isEditor=false,tool="view",selected=null;
let drawing=false,start=null,tempRect=null;

const canvas=new fabric.Canvas("c",{selection:false});
canvas.upperCanvasEl.style.touchAction = "none";
canvas.upperCanvasEl.style.webkitUserSelect = "none";
canvas.upperCanvasEl.style.webkitTouchCallout = "none";
fabric.Object.prototype.cornerSize=36;
fabric.Object.prototype.cornerStyle="circle";
fabric.Object.prototype.transparentCorners=false;
fabric.Object.prototype.targetFindTolerance=30;

// üîë Laisser Fabric capter les events
canvas.upperCanvasEl.style.pointerEvents = "auto";

// üîë Laisser passer les clics UI au-dessus
canvas.lowerCanvasEl.style.pointerEvents = "none";

function resize(){
  canvas.setWidth($("stage").clientWidth);
  canvas.setHeight($("stage").clientHeight);
  canvas.calcOffset();
}
window.addEventListener("resize",resize);
resize();

/* UI */
$("fab").onclick=()=>{$("panel").style.display=$("panel").style.display==="block"?"none":"block";};

$("btnEditor").onclick=()=>{
  if($("pw").value.trim()!==EDITOR_PASSWORD){alert("Mot de passe incorrect");return;}
  isEditor=true;tool="move";updateUI();
};
$("btnExit").onclick=()=>{
  isEditor=false;tool="view";clearSelection();updateUI();
};
$("btnMove").onclick=()=>{tool="move";applyMode();};
$("btnResize").onclick=()=>{tool="resize";applyMode();};
$("btnDraw").onclick=()=>{tool="draw";applyMode();};

function updateUI(){
  $("editorState").style.display=isEditor?"block":"none";
  $("stateLine").textContent=isEditor?"MODE √âDITEUR":"MODE √âL√àVE";
  $("btnEditor").style.display=isEditor?"none":"block";
  $("btnExit").style.display=isEditor?"block":"none";
  $("btnMove").disabled=!isEditor;
  $("btnResize").disabled=!isEditor;
  $("btnDraw").disabled=!isEditor;
  applyMode();
}

function applyMode(){
  canvas.forEachObject(o=>{
    o.selectable=isEditor && tool!=="draw";
    o.hasControls=isEditor && tool==="resize";
    o.hasBorders=isEditor;
    o.stroke=(o===selected && isEditor)?"orange":"white";
    o.strokeWidth=3;
    o.lockRotation=true;
  });
  canvas.requestRenderAll();
}

/* Selection */
function selectObj(obj){
  if(selected && selected!==obj) selected.stroke="white";
  selected=obj;
  obj.stroke="orange";
  canvas.setActiveObject(obj);
  canvas.requestRenderAll();
}
function clearSelection(){
  if(!selected) return;
  selected.stroke="white";
  selected=null;
  canvas.discardActiveObject();
  canvas.requestRenderAll();
}



  if(obj) selectObj(obj);
  else clearSelection();
});

canvas.on("mouse:move",opt=>{
  if(!(drawing&&tempRect)) return;
  const p=canvas.getPointer(opt.e);
  tempRect.set({
    left:Math.min(start.x,p.x),
    top:Math.min(start.y,p.y),
    width:Math.abs(p.x-start.x),
    height:Math.abs(p.y-start.y)
  });
  canvas.requestRenderAll();
});

canvas.on("mouse:up",()=>{
  if(!(drawing&&tempRect)) return;
  drawing=false;
  const r=tempRect;
  canvas.remove(tempRect);tempRect=null;
  if(r.width<12||r.height<12) return;

  const zone=new fabric.Rect({
    left:r.left,top:r.top,width:r.width,height:r.height,
    fill:"rgba(255,255,255,0.08)",stroke:"white",strokeWidth:3
  });
  zone.zoneId="nouvelle_zone";
  canvas.add(zone);
  applyMode();
});

/* Load zones */
ZONES.forEach(z=>{
  const r=new fabric.Rect({
    left:z.x,top:z.y,width:z.w,height:z.h,
    fill:"rgba(255,255,255,0.08)",stroke:"white",strokeWidth:3
  });
  r.zoneId=z.id;
  canvas.add(r);
});

updateUI();
</script>
</body>
</html>