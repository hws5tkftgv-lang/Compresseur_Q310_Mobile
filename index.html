<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Q310 â€“ MOBILE iPhone</title>

<script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>

<style>
html,body{
  margin:0;
  background:#0b1436;
  color:#eaf1ff;
  font-family:Arial,Segoe UI,sans-serif;
  overscroll-behavior:none;
  touch-action:none;
}

.topbar{
  display:flex;
  gap:6px;
  padding:8px;
  background:#0f1a3f;
}

.btn{
  flex:1;
  min-height:44px;
  font-size:15px;
  background:#1b2553;
  color:#fff;
  border:1px solid rgba(255,255,255,.2);
}

.stage{
  position:relative;
  height:65vh;
  background:#0b1536;
  overflow:hidden;
}

.media-layer,canvas{
  position:absolute;
  inset:0;
}


#infoPanel{
  padding:10px 12px;
  background:#0f1a44;
  border-bottom:1px solid rgba(255,255,255,.15);
}

#infoTitle{
  font-size:18px;
  font-weight:700;
  margin-bottom:4px;
}

#infoRole{
  font-size:15px;
  opacity:.95;
  margin-bottom:4px;
}

#infoDesc{
  font-size:15px;
  line-height:1.4;
  opacity:.9;
}
  #btnEditor{
  position:fixed;
  bottom:8px;
  left:8px;
  width:34px;
  height:34px;
  border-radius:6px;
  background:rgba(255,255,255,.15);
  color:#fff;
  border:1px solid rgba(255,255,255,.3);
  font-size:16px;
  opacity:.35;
  z-index:9999;
}
#btnEditor.active{
  opacity:.9;
  background:#0078ff;
}
#editorBadge{
  position:fixed;
  top:8px;
  right:8px;
  padding:6px 10px;
  background:#ff9800;
  color:#000;
  font-weight:700;
  font-size:13px;
  border-radius:4px;
  display:none;
  z-index:9999;
}

</style>
</head>

<body>
<meta name="apple-mobile-web-app-capable" content="yes">

<div id="infoPanel">
  <div id="infoTitle">SÃ©lectionne une zone</div>
  <div id="infoRole"></div>
  <div id="infoDesc"></div>
</div>


<div class="stage" id="stage">
  <div class="media-layer">
    <img id="imgLayer">
  </div>
  <canvas id="c"></canvas>
</div>

 <button id="btnEditor">âœŽ</button>

<script>
  let editorPanDisabled = false;

/* ================== CONFIG ================== */
const IMAGE_URL = "/actif/compresseur_bg.png";
const ZONES_KEY = "q310_ios_zones";

/* ================== CANVAS ================== */
const canvas = new fabric.Canvas("c",{
  selection:true,
  allowTouchScrolling:false,
  preserveObjectStacking:true
});

const imgEl = document.getElementById("imgLayer");
const stage = document.getElementById("stage");

/* ================== IMAGE ================== */
imgEl.src = IMAGE_URL;
imgEl.onload = ()=>{
  resizeAll();
  loadRealZones();
};


function resizeAll(){
  canvas.setWidth(stage.clientWidth);
  canvas.setHeight(stage.clientHeight);

  imgEl.style.width = stage.clientWidth+"px";
  imgEl.style.height = stage.clientHeight+"px";
}
function loadRealZones(){
  canvas.clear();
  ZONES_PC.forEach(z=>{
    makeZone(
      z.x * stage.clientWidth,
      z.y * stage.clientHeight,
      z.w * stage.clientWidth,
      z.h * stage.clientHeight,
      z.text
    );
  });
}

/* ================== ZONES ================== */
function makeZone(x,y,w,h,text){
  const r = new fabric.Rect({
    left:x, top:y, width:w, height:h,
    fill:"rgba(0,0,0,0)",
    stroke:"rgba(255,255,255,.8)",
    strokeWidth:2,
    selectable:true,
    evented:true,
    hasControls:false,
hasBorders:true,
lockScalingX:true,
lockScalingY:true,
lockRotation:true
    
  });
  r.comment = text;
  r.on("mousedown", ()=>{
  document.getElementById("infoTitle").textContent = r.comment;

  if(isEditor){
    const n = prompt("Nom de la piÃ¨ce :", r.comment);
    if(n){
      r.comment = n;
      document.getElementById("infoTitle").textContent = n;
    }
  }
});

  canvas.add(r);
  r.bringToFront();

  r.on("mousedown", ()=>{
  document.getElementById("infoTitle").textContent = r.comment;
  document.getElementById("infoRole").textContent = "RÃ´le Ã  dÃ©finir";
  document.getElementById("infoDesc").textContent = "";
});

}

function loadZones(){
  const raw = localStorage.getItem(ZONES_KEY);
  if(!raw) return;
  JSON.parse(raw).forEach(z=>{
    makeZone(z.x,z.y,z.w,z.h,z.text);
  });
}

/* ================== BULLE ================== */
let bubbleTimer=null;
//function showBubble(text,x,y){
  //const b=document.getElementById("bubble");
  //b.textContent=text;
  //b.style.left=x+"px";
  //b.style.top=y+"px";
  //b.style.display="block";
  //clearTimeout(bubbleTimer);
  //bubbleTimer=setTimeout(()=>b.style.display="none",4000);
//}

/* ================== TOUCH LOGIC (PAN + TAP LONG) ================== */
let lastTouch = null;
let isPanning = false;
let longPressTimer = null;

canvas.upperCanvasEl.addEventListener("touchstart", e => {
  if(isEditor) return;
  e.preventDefault();

  const t = e.touches[0];
  lastTouch = { x: t.clientX, y: t.clientY };
  isPanning = false;

  const target = canvas.findTarget(t);

  if (target) {
    longPressTimer = setTimeout(() => {
      const pt = canvas.getPointer(t);
     // showBubble(target.comment, pt.x + 10, pt.y + 10);
    }, 600);
  }
}, { passive: false });

canvas.upperCanvasEl.addEventListener("touchmove", e => {
  if(isEditor) return;
  e.preventDefault();
  clearTimeout(longPressTimer);

  const t = e.touches[0];
  if (!lastTouch) return;

  const dx = t.clientX - lastTouch.x;
  const dy = t.clientY - lastTouch.y;

  // ðŸ‘‰ PAN DU CANVAS
 // const vpt = canvas.viewportTransform;
  //vpt[4] += dx;
  //vpt[5] += dy;
  //canvas.setViewportTransform(vpt);

  lastTouch = { x: t.clientX, y: t.clientY };
  isPanning = true;
}, { passive: false });

canvas.upperCanvasEl.addEventListener("touchend", () => {
  if(isEditor) return;
  clearTimeout(longPressTimer);
  lastTouch = null;
  isPanning = false;
}, { passive: false });


/* ================== ZONES RÃ‰ELLES (PC â†’ iPhone) ================== */
const ZONES_PC = [
  { x:0.263, y:0.553, w:0.283, h:0.077, text:"Carter" },
  { x:0.120, y:0.263, w:0.213, h:0.282, text:"Intercooler" },
  { x:0.646, y:0.293, w:0.201, h:0.183, text:"Cylindre basse pression" },
  { x:0.309, y:0.056, w:0.160, h:0.116, text:"Unloader" },
  { x:0.784, y:0.553, w:0.226, h:0.158, text:"Filtre Ã  huile" },
  { x:0.001, y:0.367, w:0.123, h:0.196, text:"Volant" },
  { x:0.642, y:0.547, w:0.113, h:0.086, text:"ManomÃ¨tre pression dâ€™huile" },
  { x:0.432, y:0.309, w:0.104, h:0.094, text:"Cylindre haute pression" },
  { x:0.444, y:0.428, w:0.087, h:0.086, text:"Bielle" }
];

/* ================== MODE Ã‰DITEUR ================== */
let isEditor = false;
const EDITOR_PASSWORD = "comp";

document.getElementById("btnEditor").addEventListener("click", ()=>{
  if(isEditor) return;
  if(!isEditor){
    const p = prompt("Mot de passe Ã©diteur");
    if(p !== EDITOR_PASSWORD) return;
    enableEditor(true);
  }else{
    enableEditor(false);
  }
});

function enableEditor(on){
  isEditor = on;

  document.getElementById("btnEditor").classList.toggle("active", on);
  document.getElementById("editorBadge").style.display = on ? "block" : "none";

  canvas.selection = on;

  canvas.forEachObject(o=>{
    o.selectable = on;
    o.evented = true;

    o.hasControls = on;
    o.hasBorders  = on;

    o.lockRotation = true;
    o.lockScalingFlip = true;

    // ðŸ”‘ CLÃ‰ MOBILE
    o.perPixelTargetFind = true;
    o.targetFindTolerance = 15;

    // feedback visuel
    o.stroke = on ? "orange" : "rgba(255,255,255,.8)";
    o.strokeWidth = on ? 3 : 2;
  });

  canvas.discardActiveObject();
  canvas.requestRenderAll();
}



</script>
 <div id="editorBadge">MODE Ã‰DITEUR</div>

</body>
</html>
