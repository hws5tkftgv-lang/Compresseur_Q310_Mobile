<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Q310 â€“ Mobile</title>

<script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>

<style>
html,body{
  margin:0;
  background:#0b1436;
  color:#eaf1ff;
  font-family:Arial,Segoe UI,sans-serif;
  overscroll-behavior:none;
  touch-action:none;
}

#infoPanel{
  padding:10px 12px;
  background:#0f1a44;
  border-bottom:1px solid rgba(255,255,255,.15);
}
#infoTitle{font-size:18px;font-weight:700;}
#infoRole{font-size:15px;margin-top:4px;}
#infoDesc{font-size:15px;margin-top:4px;line-height:1.4;}

.stage{
  position:relative;
  height:75vh;
  overflow:hidden;
}
.media-layer,canvas{position:absolute;inset:0;}
#imgLayer{
  width:100%;height:100%;
  object-fit:contain;
  pointer-events:none;
}

#btnEditor{
  position:fixed;
  bottom:10px;left:10px;
  width:38px;height:38px;
  background:#ffffff22;
  border:1px solid #ffffff55;
  color:#fff;
  font-size:18px;
  border-radius:6px;
  z-index:999;
}
#btnEditor.active{background:#ff9800;color:#000;}

#editorBadge{
  position:fixed;
  top:10px;right:10px;
  background:#ff9800;
  color:#000;
  font-weight:700;
  padding:6px 10px;
  border-radius:4px;
  display:none;
  z-index:999;
}
  canvas {
  touch-action: manipulation !important;
}

</style>
</head>

<body>

<div id="infoPanel">
  <div id="infoTitle">SÃ©lectionne une zone</div>
  <div id="infoRole"></div>
  <div id="infoDesc"></div>
</div>

<div class="stage" id="stage">
  <div class="media-layer">
    <img id="imgLayer">
  </div>
  <canvas id="c"></canvas>
</div>

<button id="btnEditor">âœŽ</button>
<div id="editorBadge">MODE Ã‰DITEUR</div>

<script>
  let zoneObjects = [];

/* ================= CONFIG ================= */
const IMAGE_URL = "actif/compresseur_bg.png";
const ZONES_URL = "zones_mobile.json";
const PARTS_URL = "quincy_310L_parts.json";
const EDITOR_PASSWORD = "comp";

/* ================= UI ================= */
const infoTitle = infoRole = infoDesc = null;
const t = id=>document.getElementById(id);
const setInfo=(a,b="",c="")=>{
  t("infoTitle").textContent=a||"";
  t("infoRole").textContent=b||"";
  t("infoDesc").textContent=c||"";
};

/* ================= CANVAS ================= */
const stage = t("stage");
const imgEl = t("imgLayer");
const canvas = new fabric.Canvas("c",{selection:false});
fabric.Object.prototype.perPixelTargetFind=true;
fabric.Object.prototype.targetFindTolerance=12;

/* ================= DATA ================= */
let parts=new Map();
let zones=[];
let isEditor=false;
let imgW=1,imgH=1;

/* ================= LOAD ================= */
async function fetchJSON(url){
  const r=await fetch(url,{cache:"no-store"});
  return await r.json();
}

async function loadParts(){
  (await fetchJSON(PARTS_URL)).forEach(p=>parts.set(p.id,p));
}

async function loadZones(){
  zones=await fetchJSON(ZONES_URL);
}

function resize(){
  canvas.setWidth(stage.clientWidth);
  canvas.setHeight(stage.clientHeight);
}

function computeScale(){
  const sw=stage.clientWidth, sh=stage.clientHeight;
  const ir=imgW/imgH, sr=sw/sh;
  let dw,dh,ox,oy;
  if(sr>ir){dh=sh;dw=sh*ir;ox=(sw-dw)/2;oy=0;}
  else{dw=sw;dh=sw/ir;ox=0;oy=(sh-dh)/2;}
  return {sx:dw/imgW,sy:dh/imgH,ox,oy};
}

function drawZones(){
  canvas.clear();
  zoneObjects = [];

  const {sx,sy,ox,oy} = computeScale();

  zones.forEach(z=>{
    const r = new fabric.Rect({
      left: ox + z.x * sx,
      top:  oy + z.y * sy,
      width:  z.w * sx,
      height: z.h * sy,

      fill: "rgba(0,0,0,0)",
      stroke: isEditor ? "orange" : "rgba(255,255,255,0.9)",
      strokeWidth: 3,

      selectable: isEditor,
      evented: true,
      hasControls: isEditor,
      hasBorders: isEditor,

      lockRotation: true,
      lockScalingFlip: true,
      transparentCorners: false,
      cornerColor: "#ff9800",
      cornerStyle: "circle"
    });

    r.partId = z.partId;

    r.on("mousedown", ()=>{
      const p = parts.get(r.partId);
      if(p){
        setInfo(p.nom, p.role, p.desc);
      }else{
        setInfo(r.partId);
      }
    });

    zoneObjects.push(r);
    canvas.add(r);
  });

  canvas.requestRenderAll();
}

function exportZones(){
  const {sx,sy,ox,oy}=computeScale();
  const out=canvas.getObjects().map(o=>({
    partId:o.partId||"nouvelle_zone",
    x:Math.round((o.left-ox)/sx),
    y:Math.round((o.top-oy)/sy),
    w:Math.round(o.width*o.scaleX/sx),
    h:Math.round(o.height*o.scaleY/sy)
  }));
  prompt("Copie ce JSON :",JSON.stringify(out,null,2));
}

/* ================= EDITOR ================= */
t("btnEditor").onclick = ()=>{
  if(!isEditor){
    if(prompt("Mot de passe") !== EDITOR_PASSWORD) return;
    isEditor = true;
  }else{
    isEditor = false;
  }

  t("btnEditor").classList.toggle("active", isEditor);
  t("editorBadge").style.display = isEditor ? "block" : "none";

  // ðŸ”‘ activer / dÃ©sactiver les zones EXISTANTES
  zoneObjects.forEach(o=>{
    o.selectable   = isEditor;
    o.hasControls  = isEditor;
    o.hasBorders   = isEditor;
    o.stroke       = isEditor ? "orange" : "rgba(255,255,255,0.9)";
  });

  canvas.selection = isEditor;
  canvas.discardActiveObject();
  canvas.requestRenderAll();
};


/* ================= BOOT ================= */
(async()=>{
  setInfo("Chargementâ€¦");
  resize();
  await loadParts();
  await loadZones();
  imgEl.onload=()=>{
    imgW=imgEl.naturalWidth;imgH=imgEl.naturalHeight;
    drawZones();
    setInfo("SÃ©lectionne une zone");
  };
  imgEl.src=IMAGE_URL;
})();
</script>

</body>
</html>
